<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Modern C++ Component</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Modern C++ Component</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>An adaptable approach to build and distribute usable C++ software components</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_context_lite">Context-lite</a></li>
<li><a href="#_motivations">Motivations</a></li>
<li><a href="#_philosophy">Philosophy</a></li>
<li><a href="#special_case">C&#43;&#43; special case</a></li>
<li><a href="#_audience">Audience</a></li>
<li><a href="#_design">Design</a></li>
</ul>
</li>
<li><a href="#_the_process">The process</a>
<ul class="sectlevel2">
<li><a href="#_structuring_content">Structuring content</a></li>
<li><a href="#_building_code">Building code</a></li>
<li><a href="#cmake-package">Packaging components (becoming an upstream dependency): CMake</a></li>
<li><a href="#_distribution_conan">Distribution: Conan</a></li>
</ul>
</li>
<li><a href="#_usage">Usage</a>
<ul class="sectlevel2">
<li><a href="#_affinity_with_different_workflows">Affinity with different workflows</a></li>
<li><a href="#_development">Development</a></li>
<li><a href="#command-line-usage">Command-line user</a></li>
<li><a href="#_general_public">General public</a></li>
</ul>
</li>
<li><a href="#_annexes">Annexes</a>
<ul class="sectlevel2">
<li><a href="#_automated_qa">Automated QA</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_context_lite">Context-lite</h3>
<div class="paragraph">
<p>C&#43;&#43; is an ISO standard based on the Abstract Machine, it keeps far from the practical
and gory details addressing how to build it, even less how to distribute it.</p>
</div>
<div class="paragraph">
<p>Building and distribution are the realm of 3rd party actors and tools -distinct from the committee-
(some people from this realm are sitting on the committee, but this fact does not change the ISO standard scope).
As a result, there is little to no standard-prescribed way to go about steps once the code is written.</p>
</div>
</div>
<div class="sect2">
<h3 id="_motivations">Motivations</h3>
<div class="paragraph">
<p>The aim of this document is to gather in one place the steps allowing to create
native software with the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cross-platform and <em>reasonably</em> cross-toolset</p>
</li>
<li>
<p>Usable and re-usable (consumer perspective)</p>
<div class="ulist">
<ul>
<li>
<p>By other developers in the same or unrelated organisations</p>
</li>
<li>
<p>By automated processes (e.g. CI)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Easy to share (provider/maintainer perspective)</p>
</li>
<li>
<p>Modular</p>
</li>
<li>
<p>Uniform: Both the process and the resulting package have to work great for naively small projects as well as massive code bases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the current era of Modern C&#43;&#43;, the language itself leads a potential change in the mindset of C&#43;&#43; developers.
Those changes are pervading the C&#43;&#43; ecosystem and tooling.
This document does not explore the language itself, but how to actually achieve and take advantage of the properties in the above list, by relying on modern tools.</p>
</div>
<div class="paragraph">
<p>Equally important is hopefully being able to <strong>convey the appropriate mindset</strong>, so those properties are both understood and desired.</p>
</div>
<div class="paragraph">
<p>There is no standard, no undisputed approach, and no silver-bullet.
But there are solutions with varying levels of traction and growth,
and active projects refining themselves.
By providing <strong>a write-up of an end-to-end (holistic) approach</strong>, another goal is to try and <strong>attract collaborators</strong> with different specialisations, eventually leveraging expert-knowledge regarding specific cogs in the system.<br>
In addition to support enhancing each step, this document also serves as a repository of the different
friction-points in the interactions of parts, <strong>recording potential future enhancements</strong>.</p>
</div>
<div class="paragraph">
<p>Why adhering to a pre-defined process? Theoretically, the properties above could be reached
via innumerable different ways.<br>
In practical situations, each process implements a different trade-off.
Reaching a satisfying yet adaptable infrastructure requires a lot of research, prototyping, and validation. The later the build infrastructure of a codebase is addressed, the costlier its deployment tends to be.</p>
</div>
<div class="paragraph">
<p>Adopting a common and predefined plan greatly reduce the upfrong cost, with other advantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Having <strong>good defaults</strong> saves on initial setup and discussions (i.e. <a href="https://www.youtube.com/watch?v=XkDEzfpdcSg&amp;feature=youtu.be&amp;t=195">avoid bike-shedding</a>). The value added part is the software, not its building and packaging logic.</p>
</li>
<li>
<p>Having a common base gives better chance at <strong>interoperability</strong>.</p>
</li>
<li>
<p>Someone already <strong>documented the process</strong> for you, and you might not even have to maintain this document.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_philosophy">Philosophy</h3>
<div class="paragraph">
<p>Producing sociable components might require some change in the usual approach:
it becomes the responsibility of the component itself to take extra measures and precautions in order to be easily buildable, usable and distributable.</p>
</div>
<div class="paragraph">
<p>This might contrast with a traditional approach where the burden is on downstream(s) to adapt to the libraries it uses,
which might encourage organisations to adhere to an isolation mental model, i.e. to stay away from external dependencies as much as possible.</p>
</div>
<div class="sect3">
<h4 id="_the_best_process_in_the_world">The best process in the world?</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>... actually does not sound anything like this doc.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Tenacious C
</div>
</div>
<div class="paragraph">
<p>Yet the Platonic ideal sets the cap.</p>
</div>
<div class="paragraph">
<p>This mythical best system would allow every user to create sociable code by default,
without wasted effort (Of course, there is intrinsic effort required).<br>
It would allow every user to re-use sociable code through well-defined and concise steps,
without imposing any limitation on usage contexts.</p>
</div>
<div class="paragraph">
<p>There are software quality principles and metrics to evaluate where a process stands.
Let&#8217;s establish them as goals for the process:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Practicality</p>
</li>
<li>
<p>Simplicity and straightforwardness</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Open%E2%80%93closed_principle">Open-Closed</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a></p>
</li>
<li>
<p>Separation of concerns</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The actual system will not be able to strictly enforce all goals at once, but they remain excellent
parameters to consider along the way, in order to make informed engineering decisions and trade-offs.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="special_case">C&#43;&#43; special case</h3>
<div class="paragraph">
<p>Many high level languages are able to provide sociable components quite naturally, without requiring to first agree on some external process.
Or they have one (a few) de-facto standard.</p>
</div>
<div class="paragraph">
<p>In addition to the fact that the C&#43;&#43; standard does not make any prescription, C&#43;&#43; (as other native languages) is a special case.
It is not trivial to distribute a project that builds easily on all environments, while it is close to impossible to distribute pre-built objects for all environments due to the combinatorial explosion of build parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Project versions</p>
</li>
<li>
<p>Static / Shared libraries</p>
</li>
<li>
<p>ABIs (compilers, and compilers' versions)</p>
</li>
<li>
<p>Standard library</p>
</li>
<li>
<p>The gazillion compilation flags, which are also compiler dependent</p>
<div class="ulist">
<ul>
<li>
<p>Debug, Release, MinSize, and a few other build types</p>
</li>
<li>
<p>Optimisation level</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>The upstream dependency-diamond (two separate components might rely on the same upstream library)</p>
</li>
<li>
<p>Code instrumentation</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_audience">Audience</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO</div>

</div>
</div>
</div>
<div class="sect2">
<h3 id="_design">Design</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO</div>

</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_process">The process</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describe an end-to-end approach to deliver modern C&#43;&#43; components : {Sonat}</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO</div>
<div class="paragraph">
<p>Find a good short name for the process: Sonat will do for now.</p>
</div>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><a href="https://www.youtube.com/watch?v=S4QSKLXdTtA&amp;feature=youtu.be&amp;t=134">Please do not partition our C&#43;&#43; development environment even more</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The tools recommendation is the same as in Mateusz Pusz presentation above (there is hope for a status quo):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VCS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>git</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Build system management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>CMake</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Package management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Conan</strong></p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_structuring_content">Structuring content</h3>
<div class="sect3">
<h4 id="_repositories">Repositories</h4>
<div class="paragraph">
<p>The first practical decision when starting a new project from scratch will be the granularity of the repository. <a href="https://medium.com/@johnclarke_82232/mono-or-multi-repo-6c3674142dfc">The monorepo, the multirepo (repo-per-component)</a>, and the reality in between.</p>
</div>
<div class="paragraph">
<p>One of monorepo&#8217;s advantages is facility to setup and use with most toolsets, avoiding different complications to locate dependent components.</p>
</div>
<div class="paragraph">
<p>One of multirepo&#8217;s advantages is about automation:<br>
The easily detectable "atomic unit of change" is the VCS commit (or push).
Where there is only one component in the repo, there is no question as to which component processes should be triggered
when change is detected.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Generally our tooling works at repo level</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>As a general rule of thumb, smaller granularity gives better control and flexibility.</p>
</div>
<details>
<summary class="title">Implementing Conan recipes for 3rd party software</summary>
<div class="content">
<div class="paragraph">
<p>An organisation relying on Conan has dependencies overs software not offering Conan package.
To adress this situation, the organisation writes Conan recipes for these package.
Ideally, each time a recipe code is pushed back to the central repo,
the organisation&#8217;s CI would pick it and publish the updated recipe.
If a single repositories host tens of recipes, the process will either be naive and wasteful, or
will require additional logic to rebuild only the edited recipe(s).
If each recipe is hosted in a separate repository, it will be trivial to only trigger a build
for the changed recipe.</p>
</div>
</div>
</details>
<details>
<summary class="title">Updating compiler</summary>
<div class="content">
<div class="paragraph">
<p>Another illustration is how monorepo makes it harder for a single team to change compiler in isolation, even in the context of a stable ABI.
Since the new compiler might be more strict regarding C++ standard, it could raise new errors and warnings in the codebase.
The compiler change is applied to an entire repository at once:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In a multirepo, the team will be able to adapt its own component in isolation.</p>
</li>
<li>
<p>In a monorepo, the compiler change has to be synchronized across all teams.</p>
</li>
</ul>
</div>
</div>
</details>
<div class="sect4">
<h5 id="_in_practice">In practice</h5>
<div class="ulist">
<ul>
<li>
<p>Pure monorepo is not scalable (i.e. in the context of sociable code).
The axiom being that "upstream cannot and should not know all downstreams".<br></p>
</li>
<li>
<p>On the other hand, strictly one repo per component is not practical in the absence of good tool support [see note below].
The idea of manually having to clone and separately build a handful of independent repos
for even medium-sized applications should trigger the maintainability alarm.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Different approaches and tools exist to manage multi-repos. Git <a href="https://github.blog/2016-02-01-working-with-submodules"><code>submodule</code></a> is an easily accessible tool, since it is integrated with core Git installations. Yet, a recurrent criticism is submodules do not scale well as they are unpractical to use.
In particular, the more correlated the submodules/module, the more this can become a problem.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Correlation measure</div>
<div class="paragraph">
<p>Likeliness that changes in entity B would entail changes in entity A.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The proposed system recognises the existence of both mono and multi repo,
placing them as extrema on a line along which organisations are allowed to move as the development progresses.</p>
</div>
<details>
<summary class="title">Organically growing codebase</summary>
<div class="content">
<div class="paragraph">
<p>Application B can start as a library (libA) and its frontend (B).
Seeing how they are lock-stepped, it makes sense to host both in the same repo (monorepo).
Then, identified generic functionalities can be moved out of libA in libCommon. libCommon can
start its existence in the same repo, and later on move to a separate repo to be offered to other internal projects and/or 3rd parties. There is value in adaptability.</p>
</div>
</div>
</details>
<div id="anyrepo" class="sidebarblock">
<div class="content">
<div class="title">In a nutshell</div>
<div class="paragraph">
<p>The actual system should be able to accommodate <em>monorepos</em> and <em>multi-repos</em>, as well
as the reality in between: let&#8217;s call it <em>anyrepo</em>. It does not allow for circular dependencies.<br>
The formalisation is that repositories can contain 1..N components, and can depend on components in
0..M other repositories. Repositories dependencies are a DAG.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="filesystem_organisation">Filesystem organisation</h4>
<div class="paragraph">
<p>Once defined which component(s) will be held inside a repository, the repository must be organised in a files and folders hierarchy.</p>
</div>
<div class="listingblock">
<div class="title">{Sonat} proposed structure</div>
<div class="content">
<pre>CMakeLists.txt (cmr)
README.{xy}
cmake/
toolA/
toolB/
...
src/
    CMakeLists.txt (cmp)
    apps/
        C/
            C/
                CMakeLists.txt (cmc-C)
                main.cpp
                appclass.h
                appclass.cpp
                ...
        ...
    libs/
        A/
            A/
                CMakeLists.txt (cmc-A)
                accumulate.h
                accumulate.cpp
                sum.h
                sum.cpp
                ...
                subcomponent/
                    ...
        B/
            B/
                CMakeLists.txt (cmc-B)
                multiply.h
                ...
        ...
    ...
resources/</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
See <a href="#duplicated-libname-folder">the rationale behind duplicated <code>A</code>, <code>B</code> and <code>C</code> folders</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
{Sonat} is intended to be extensible and adaptable.<br>
This is notably the case with the filesystem structure.
Additional tool-specific files can be added in the tools folder.
Other type of components can be added, for example <code>plugins</code> folder could exist alongside, or replace, <code>libs</code>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_readme">README</h5>
<div class="paragraph">
<p>The <code>README</code>, even a few lines, makes the most difference when a human encounters a repository for the first time.
It is the informal social introduction.</p>
</div>
<div class="paragraph">
<p>Like the rest of the code, it should be treated as an evolving piece of information.</p>
</div>
<div class="olist arabic">
<div class="title">An potential README outline</div>
<ol class="arabic">
<li>
<p>The first paragraph <strong>describes the functionality of the project / components</strong>.  As well as the intended audience.</p>
</li>
<li>
<p>Optional examples.</p>
</li>
<li>
<p><strong>Usage section</strong>, with sub-sections for relevant situations. Classically:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>building</em></p>
</li>
<li>
<p><em>installing</em></p>
</li>
<li>
<p><em>using</em></p>
</li>
</ol>
</div>
</li>
<li>
<p>Pointers to the documentation(s).</p>
</li>
<li>
<p>Section explaining the contribution model, issue reporting, question asking, or explicitly stating they are not welcome.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_code">Building code</h3>
<div class="sect3">
<h4 id="_portability_considerations">Portability considerations</h4>
<div class="paragraph">
<p>Standard C++ is a cross platform language, with an ever growing ecosystem of tools. Yet the limiting factor for portability often turns out to be the build system.</p>
</div>
<div class="paragraph">
<p>Achieving a cross-platform and cross-toolset (code editors, compilers and analysers) build system, while keeping it DRY, is a notable challenge.</p>
</div>
<details>
<summary class="title">DON&#8217;T: Many project files and component configurations in the repo</summary>
<div class="content">
<div class="paragraph">
<p>Committing a "project file" per combination would violate DRYness, making it very likely to introduce errors for the system that are not in use when transformations are applied.
Moreover, it becomes a burden to add other build systems as soon as the project reaches a moderate size.</p>
</div>
</div>
</details>
<div class="paragraph">
<p><a href="https://cmake.org/">CMake</a> is a free and open-source build management system.
It places itself one level of abstraction above the makefile/IDE project files:
it can be seen (at first) as a project file generator for different toolsets.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO</div>
<div class="paragraph">
<p>Provide CMake usage statistics and evolution</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_building_with_sonat">Building with {Sonat}</h4>
<div class="paragraph">
<p>When it comes to building, the process requires those essential features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cross-platform and cross toolset</p>
</li>
<li>
<p>Ability to satisfy upstream dependencies</p>
</li>
<li>
<p>Out of source builds</p>
</li>
<li>
<p>Versionable build process</p>
</li>
<li>
<p>Component level granularity for builds</p>
</li>
<li>
<p>Uniform interface to trigger build of selected components, configurations, and combinations of both</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>CMake is able to address these different points.
It relies on <code>CMakeLists.txt</code> files, with optional <code>xxx.cmake</code> accompanying scripts.
Those are plain text files, thus manageable as any other source file by the versioning system.</p>
</div>
<div class="paragraph">
<p>Conceptually, {Sonat} relies on three categories of <code>CMakeLists.txt</code> files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The root file (cmr), located at the root of the repository.</p>
</li>
<li>
<p>The per-component <code>CMakeLists.txt</code> (cmc-x), at the root of each individual component folder</p>
</li>
<li>
<p>The plumbing <code>CMakeLists.txt</code> (cmp)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_root_cmakelists">Root CMakeLists</h5>
<div class="paragraph">
<p>It is responsible for initialising CMake and expressing what is common to all, or most, components.</p>
</div>
<div class="paragraph">
<p>Base:</p>
</div>
<div class="listingblock">
<div class="title">CMakeLists.txt</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake"># CMake initialisation
cmake_minimum_required(VERSION 3.15)

# Setting the VERSION on root project() will populate CMAKE_PROJECT_VERSION
project(MyRepository
        VERSION "${BUILD_VERSION}")

# Common build settings
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

# Include components
add_subdirectory(src)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>add_subdirectory(src)</code> directive, CMake executes the named <code>CMakeLists.txt</code> in the <code>src/</code> subdirectory (cmp).</p>
</div>
<div class="paragraph">
<p>This top-level file sets the default (likely minimal requirement) C++ standard, unless a value was already provided for <code>CMAKE_CXX_STANDARD</code> variable.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Making <code>CMAKE_CXX_STANDARD</code> a cache variable would allow to remove the <code>if</code>.
Yet it is not known of which nature the variable could already be. (e.g. Conan <code>basic_conan_setup()</code> sets it as non-cache)
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO</div>
<div class="paragraph">
<p>Find a way to control warning level and enable <em>warning as errors</em> for all / some targets, without making it a build requirement.
Consumers should be able to build a project even if it generates warning on their newer compilers.
Warning should only be treated as errors during development/testing, when the workflow dictates so.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_plumbing_cmakelists">Plumbing CMakeLists</h5>
<div class="paragraph">
<p>This file will add the individual components.
It can use basic logic to conditionally add some components (e.g. Making the <code>tests</code> application optional).</p>
</div>
<div class="listingblock">
<div class="title">src/CMakeLists.txt</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">add_subdirectory(libs/A/A)
add_subdirectory(libs/B/B)

add_subdirectory(apps/C/C)

option(BUILD_tests)
if (BUILD_tests)
 add_subdirectory(apps/tests/tests)
endif()</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_per_component_cmakelists">Per-component CMakeLists</h5>
<div class="paragraph">
<p>One <em>leaf</em> CMakeLists is present in each component, included by (cmp).
It is responsible for actually describing how the component is built.</p>
</div>
<div class="paragraph">
<p>The process relies on the nested project name as the component&#8217;s name, and additionally defines several variable for internal use.
This is to ensure a DRY solution, in particular when it comes to lists.</p>
</div>
<div class="listingblock">
<div class="title">src/libs/A/A/CMakeLists.txt (component without upstream dependencies)</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">project(A VERSION "${CMAKE_PROJECT_VERSION}")

set(${PROJECT_NAME}_HEADERS
    accumulate.h
    sum.h
)

set(${PROJECT_NAME}_SOURCES
    accumulate.cpp
    sum.cpp
)

# Creates the library target
add_library(${PROJECT_NAME}
            ${${PROJECT_NAME}_HEADERS}
            ${${PROJECT_NAME}_SOURCES})

add_library(myrepo::${PROJECT_NAME} ALIAS ${PROJECT_NAME})

# Defines target requirements
target_include_directories(${PROJECT_NAME}
    PUBLIC
        "$&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../&gt;"
    INTERFACE
        "$&lt;INSTALL_INTERFACE:include/${PROJECT_NAME}&gt;")

# Defines target properties
set_target_properties(${PROJECT_NAME}
    PROPERTIES
        VERSION "${${PROJECT_NAME}_VERSION}")</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Modern CMake</div>
<div class="paragraph">
<p><a id="old-cmake-vars"></a>CMake was initially holding all the properties and requirements (include path, upstream libraries paths, build flags, etc.) in variables and manually setting them at each folder level.</p>
</div>
<div class="paragraph">
<p>Some years ago, CMake changed toward what is known as Modern CMake:
CMake targets represent the individual software components, encapsulating their requirements and propagating these requirements to downstream projects.<br>
Daniel Pfeifer offers a great presentation of this topic in the video <a href="https://www.youtube.com/watch?v=bsXLMQ6WgIk">Effective CMake (C++now 2017)</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The base snippet above does a few things, and is hopefully direct about each:</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>project(A VERSION "${CMAKE_PROJECT_VERSION}")</pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Implicitly defines the variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PROJECT_NAME</code> initialised to "A"</p>
</li>
<li>
<p><code>${PROJECT_NAME}_VERSION</code> initialised to the version provided to the root project() call</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>set(${PROJECT_NAME}_HEADERS ...)

set(${PROJECT_NAME}_SOURCES ...)</pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Keeps separate list of headers and sources for the current component.</p>
</div>
<div class="paragraph">
<p>See <a href="https://cmake.org/cmake/help/latest/command/list.html"><code>list</code></a> command for advanced operations.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>add_library(${PROJECT_NAME}
            ${${PROJECT_NAME}_HEADERS}
            ${${PROJECT_NAME}_SOURCES})</pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Defines a target named <code>A</code> for this component with <code>add_library</code>.
It would build fine without listing the headers, yet doing so ensures they show up in IDEs.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>add_library(myrepo::${PROJECT_NAME} ALIAS ${PROJECT_NAME})</pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="cmake-alias-rationale"></a>Defines an alias <code>myrepo::A</code> for the target, so <code>A</code> is accessible to sibling components under namespace <code>myrepo</code>. It avoids to wonder "should the namespace be prepended in this situation?", while making it easier to relocate components independently.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>target_include_directories(${PROJECT_NAME}
 PUBLIC
     "$&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../&gt;"
 INTERFACE
     "$&lt;INSTALL_INTERFACE:include/${PROJECT_NAME}&gt;")</pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Define a build requirement: the include path.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Without this directive, this component could already include its own headers via relative path (e.g. <code>#include "sum.h"</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This directive ensures uniformity, permitting both the component source themselves and its downstream users to include the component headers via compiler&#8217;s include path (e.g. <code>#include &lt;sum.h&gt;</code>).<br>
For downstream, this is a requirement, while it is added as a convenience for the current component (most useful when including headers in other directories).</p>
</div>
<div id="duplicated-libname-folder" class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>The parent folder is added to the <code>BUILD_INTERFACE</code> include directories.
If the parent folder was directly containing all siblings components, this would break component isolation:
it would be possible to include files from any sibling components, without stating an explicit dependency on them.</p>
</div>
<div class="paragraph">
<p><strong>This is the reason for the duplicated library name folder</strong>:
this way the current component is the only component available in the added include directory.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a id="cmake-requirements-scopes"></a>Requirements are usually set on 1 out of 3 scopes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PRIVATE</code> will be used when building the component itself, i.e. <strong>build specification</strong></p>
</li>
<li>
<p><code>INTERFACE</code> will be used when building downstreams users of the component, i.e. <strong>usage requirements</strong></p>
</li>
<li>
<p><code>PUBLIC</code> is a shortcut which means both <code>PRIVATE</code> and <code>INTERFACE</code></p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<a id="cmake-private-might-forward"></a>This describe the high level semantic from CMake user perspective.<br>
In practice, <code>PRIVATE</code> requirement might still be propagated (in whole or in parts) to downstreams when the implementation dictates so.
 For example this is mandatory when linking to a static library target A, itself privately linking to another static library target B.
 Even though downstream code is not aware of B, linking downstream to A will also require linking downstream to symbols in B.
See <a href="https://cmake.org/pipermail/cmake/2016-May/063400.html" class="bare">https://cmake.org/pipermail/cmake/2016-May/063400.html</a>.
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>set_target_properties(${PROJECT_NAME}
    PROPERTIES
        VERSION "${${PROJECT_NAME}_VERSION}")</pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Defines a target property: the target version.</p>
</div>
<div class="paragraph">
<p>Many <a href="https://cmake.org/cmake/help/latest/manual/cmake-properties.7.html#target-properties">properties</a> are available for targets.
Some properties are actually requirements that can either be set with <code>set_target_properties</code> or with a dedicated CMake function.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="title">Explicitly listing files</div>
<div class="paragraph">
<p>Since the dawn of CMake and to the day of this writing, the official doc <a href="https://cmake.org/cmake/help/latest/command/file.html#filesystem">advises against <code>GLOB</code>ing</a> to collect all sources files automatically instead of listing them explicitly.
The argument stating that CMake needs the file to be touched anyway to regenerate might be seen as weak (if the files are listed explicitly, the file is touched too). The second argument has deeper implications, plus:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explicit is better than implicit</p>
</li>
<li>
<p>It makes it possible to add files conditionally depending on the target system, build parameters, etc., and any combination of those (which would be trickier with GLOB)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is a domain were tooling could alleviate the pain, for example having a script to create new files and add them to the CMakeLists.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point: duplication of library folders</div>
<div class="paragraph">
<p>The duplication of library folders is a pragmatic approach to ensure <a href="#duplicated-libname-folder">component isolation</a>, yet it makes for
an unusual folder hierarchy.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_executable_cmake_target">Executable CMake target</h6>
<div class="paragraph">
<p>Applications are created via <a href="https://cmake.org/cmake/help/latest/command/add_executable.html"><code>add_executable</code></a>. When making a native GUI application <a href="https://cmake.org/cmake/help/latest/prop_tgt/WIN32_EXECUTABLE.html#prop_tgt:WIN32_EXECUTABLE"><code>WIN_32</code></a> and/or <a href="https://cmake.org/cmake/help/latest/prop_tgt/MACOSX_BUNDLE.html#prop_tgt:MACOSX_BUNDLE"><code>MACOSX_BUNDLE</code></a> should be added after the application name.</p>
</div>
</div>
<div class="sect5">
<h6 id="_header_only_cmake_target">Header only CMake target</h6>
<div class="paragraph">
<p>Header only libraries are called <a href="https://cmake.org/cmake/help/latest/command/add_library.html#id6">Interface Libraries</a> in CMake.
Since header only components are not built themselves, they do not have <code>PRIVATE</code> requirement but only <code>INTERFACE</code>, hence the name.<br>
They are added via <code>add_library(${PROJECT_NAME} INTERFACE)</code>, and cannot list the headers as source files.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>CMake generated IDE projects show compiled targets' sources in the IDE UI, yet none are shown for interface (non-compiled) libraries.
A workaround is to create a <em>dummy</em> <a href="https://cmake.org/cmake/help/latest/command/add_custom_target.html">custom target</a>, whose sole purpose it to show up in the IDE.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>add_custom_target(${PROJECT_NAME}_ide
                  SOURCES ${${PROJECT_NAME}_HEADERS})</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cmake-find-dependencies">Using upstream dependencies: CMake</h4>
<div class="paragraph">
<p>The previous entry describes the process to build a component without upstream dependencies.
This section adds some upstream dependencies, showing how to build a component which might re-use something not provided by the standard library.</p>
</div>
<div class="sect4">
<h5 id="_finding_the_dependencies">Finding the dependencies</h5>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
The direct approach described here is only used to introduce the necessary notions.
The actual approach prescribed by the process, which should be used, is described later.<br>
Since the actual approach might appear less direct due to limitations in the tools, this intermediate step is intended as a gradual explanation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>CMake find upstream dependencies through invocation of <a href="https://cmake.org/cmake/help/latest/command/find_package.html">find_package</a> command.
It is a central command in CMake, with extensive documentation containing important information for project maintainers (strictly following {Sonat} should nevertheless make it work "out of the box").</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Modern CMake</div>
<div class="paragraph">
<p>This command has two modes</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://cmake.org/cmake/help/v3.16/command/find_package.html#id2"><code>Module</code></a></dt>
<dd>
<p>is relying on some external "Find" file (several are distributed with CMake), which traditionally <a href="#old-cmake-vars">populate variables</a>.
It can nonetheless create IMPORTED targets, as is the case with FindBoost (as distributed with CMake).</p>
</dd>
<dt class="hdlist1"><a href="https://cmake.org/cmake/help/v3.16/command/find_package.html#full-signature-and-config-mode"><code>Config</code></a></dt>
<dd>
<p>should be the preferred approach when available, but requires supports from the upstream component.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>All components created following {Sonat} are located via the more modern config mode.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To find an upstream dependency, invocations of <code>find_package()</code> are added <strong>in the per-component <code>CMakeLists.txt</code> (cmc-)</strong>. One invocation per upstream dependency, of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>find_package(UpstreamName [version [EXACT]] [REQUIRED])</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>REQUIRED</code></dt>
<dd>
<p>should appear most of the time. That is, unless the current component can actually build without this dependency (the less probable situation). It allows the overall process to fail early: at CMake configuration time, instead of build time.</p>
</dd>
<dt class="hdlist1"><code>version</code></dt>
<dd>
<p>can be specified to add a lower requirement on the version number of the dependency. <code>EXACT</code> additional keyword makes it that only the exact version is accepted.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A second type of package can be distinguished, which propose <a href="#Multiple components">multiple components</a> to be included separately. In this case, the components to find are listed after <code>COMPONENTS</code> keyword (or <code>OPTIONAL_COMPONENTS</code> for non-required components).
The syntax becomes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>find_package(UpstreamName [version [EXACT]] [REQUIRED] [COMPONENTS component1 [component2]])</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Locating upstream dependencies in the root <code>CMakeLists.txt</code></div>
<div class="paragraph">
<p>Some componentised projects locate the dependencies in (cmr), potentially removing repeated invocations of <code>find_package</code> for requirements common to multiple components under the same repository.<br>
{Sonat} instead makes each component responsible to locate its own dependencies.</p>
</div>
<div class="paragraph">
<p>The finer granularity ease potential relocation of components in other repositories, and allows each component to behave more independently.
This will also enables a better contained <a href="#cmake-package">packaging process</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO</div>
<div class="paragraph">
<p>Understand why Mateusz Pusz proposes that each component can be built in isolation, without necessarily relying on the root <code>CMakeLists.txt</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_consuming_the_dependencies">Consuming the dependencies</h5>
<div class="paragraph">
<p>Once CMake found the packages, they must be explicitly marked as dependencies for the downstream target(s).
We will consider the modern case, where packages are found as <a href="https://cmake.org/cmake/help/latest/command/add_library.html#imported-libraries"><code>IMPORTED</code> targets</a>. (Reminder: {Sonat} components are found as <code>IMPORTED</code> targets)</p>
</div>
<div class="paragraph">
<p>Stating the direct dependency relation is done via the CMake function <a href="https://cmake.org/cmake/help/latest/command/target_link_libraries.html"><code>target_link_libraries</code></a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>target_link_libraries(${PROJECT_NAME}
                      &lt;PRIVATE|PUBLIC|INTERFACE&gt; [ns::]UpstreamTarget [ns::]OtherUpstream [...]
                      [...])</pre>
</div>
</div>
<div class="paragraph">
<p>Even though its name might seem narrow compared to its actual function, this command actually provides all usage requirements for the upstream targets, in addition to the linked-to binary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Include folders</p>
</li>
<li>
<p>Compilation flags and definitions</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
<li>
<p>Propagation of usage requirements for upstream&#8217;s upstreams, recursively</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The scope of the linkage has the <a href="#cmake-requirements-scopes">usual requirement scope meaning</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Even though a syntax without specifying the scope is available, always explicitly provide the scope for easier maintainability.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="cmake-finding-dependencies-code">Putting it together</h5>
<div class="paragraph">
<p>The updated leaf <code>CMakeLists.txt</code> for a component using dependencies would look something like:</p>
</div>
<div class="listingblock">
<div class="title">src/libs/A/A/CMakeLists.txt</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">project(A VERSION "${CMAKE_PROJECT_VERSION}")

set(${PROJECT_NAME}_HEADERS
    accumulate.h
    sum.h
)

set(${PROJECT_NAME}_SOURCES
    accumulate.cpp
    sum.cpp
)

<strong>find_package(UpstreamOne REQUIRED)
find_package(UpstreamTwo 1.0 REQUIRED COMPONENTS CompA CompB)
find_package(UpstreamThree 3.2.5 EXACT REQUIRED)</strong>

# Creates the library target
add_library(${PROJECT_NAME}
            ${${PROJECT_NAME}_HEADERS}
            ${${PROJECT_NAME}_SOURCES})

add_library(myrepo::${PROJECT_NAME} ALIAS ${PROJECT_NAME})

# Defines target requirements
target_include_directories(${PROJECT_NAME}
    PUBLIC
        "$&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../&gt;"
    INTERFACE
        "$&lt;INSTALL_INTERFACE:include/${PROJECT_NAME}&gt;")

<strong>target_link_libraries(${PROJECT_NAME}
    PUBLIC
        nsOne::UpstreamOne
        nsTwo::CompA
        nsTwo::CompB
    PRIVATE
        nsThree::UpstreamThree
    INTERFACE
        myrepo::B)</strong>

# Defines target properties
set_target_properties(${PROJECT_NAME}
    PROPERTIES
        VERSION "${${PROJECT_NAME}_VERSION}")</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is also possible to specify normal (non-imported) targets defined by other components in the same repository, as is the case in this example with <code>myrepo::B</code>.
For uniformity, we are using the `ALIAS`ed target for B (following <a href="#cmake-alias-rationale">the rationale</a>.)
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cmake-package">Packaging components (becoming an upstream dependency): CMake</h3>
<div class="paragraph">
<p>The <a href="#cmake-find-dependencies">previous section</a> describes how a component can depend on others: this is the consumer side of the DAG connection.<br>
To complete the loop, this section describes how to make a component that can be used following <a href="#cmake-finding-dependencies-code">the steps above</a>: the provider side of the DAG connection.</p>
</div>
<div class="sect3">
<h4 id="cmake-installing-files">Installing the component files</h4>
<div class="paragraph">
<p>The CMake infrastructure as described up to this point covers the basic needs of a project to build in the <em>build tree</em>, i.e. under a build directory which is defined when invoking CMake.<br>
There is an additional notion of <em>install tree</em>, a folder where the components is deployed when invoking the <code>install</code> build target implicitly created by CMake.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<a href="https://cmake.org/cmake/help/latest/variable/CMAKE_INSTALL_PREFIX.html">CMAKE_INSTALL_PREFIX</a> CMake variable controls the base folder (prefix) where the installation takes place. It is important to explicitly define it to avoid the default behaviour of installing system-wide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The different signatures for <a href="https://cmake.org/cmake/help/v3.16/command/install.html?highlight=install">install</a> command provide control about which files are deployed when <code>install</code> target is built.</p>
</div>
<div class="paragraph">
<p>In particular, most of the times installing a component will mean deploying the following files:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">built binaries</dt>
<dd>
<p><code>install(TARGETS ${PROJECT_NAME})</code></p>
</dd>
<dt class="hdlist1">header files</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre>install(FILES ${${PROJECT_NAME}_HEADERS}
        DESTINATION include/${PROJECT_NAME}/${PROJECT_NAME})</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Installing header files occurs under a duplicated <code>${PROJECT_NAME}</code> folder. <a href="#duplicated-libname-folder">The rationale</a> is similar than for the duplication of component folders.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Modern(er) CMake</div>
<div class="paragraph">
<p>Until CMake 3.14, it was mandatory to specify a <code>DESTINATION</code> when installing any <code>TARGET</code> type. CMake now takes a default location from <a href="https://cmake.org/cmake/help/v3.14/module/GNUInstallDirs.html#module:GNUInstallDirs">GNUInstallDirs</a> for the most usual types.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_a_cmake_package">Preparing a CMake package</h4>
<div class="paragraph">
<p><a href="#cmake-installing-files">Installation</a> deploys all the essential files constituting a component into a given folder, as seen above.
The component now has to be made into a <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#package-layout">CMake config-file package</a>. This will allow to find it and use it from the <code>CMakeLists.txt</code> of its consumers.</p>
</div>
<div class="paragraph">
<p>The package provided by {Sonat} will be usable both from the build-tree (for <a href="#development-multirepo">developers working directly on the component as well as its downstream(s)</a>), and from the install-tree (covering local build-and-installation, as well as <a href="#command-line-usage">package manager distribution</a> of the component).</p>
</div>
<div class="paragraph">
<p>The process relies on CMake export-sets.</p>
</div>
<div class="paragraph">
<p>An export for the current target is created by editing the first <code>install</code> invocation as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>install(TARGETS ${PROJECT_NAME} <strong>EXPORT ${PROJECT_NAME}Targets</strong>)</pre>
</div>
</div>
<div class="paragraph">
<p>This export-set is then used to generate cmake files in both build and install trees:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake"># build tree
export(EXPORT ${PROJECT_NAME}Targets
       FILE ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Targets.cmake
       NAMESPACE myrepo::)

# install tree
install(EXPORT ${PROJECT_NAME}Targets
        FILE ${PROJECT_NAME}Targets.cmake
        DESTINATION lib/cmake/${PROJECT_NAME}
        NAMESPACE myrepo::)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calls to <code>find_package()</code> in downstream will
<a href="https://cmake.org/cmake/help/latest/command/find_package.html#full-signature-and-config-mode">search "for a file called &lt;PackageName&gt;Config.cmake or &lt;lower-case-package-name&gt;-config.cmake"</a>.
The code creates a file name <code>${PROJECT_NAME}Target.cmake</code>.
A file named <code>${PROJECT_NAME}Config.cmake</code>, which includes the <code>${PROJECT_NAME}Target.cmake</code> file, is created via a call to <a href="https://cmake.org/cmake/help/latest/command/configure_file.html"><code>configure_file</code></a>.</p>
</div>
<div class="paragraph">
<p>While doing that, it is possible to add basic version checks using a file generated by the
<a href="https://cmake.org/cmake/help/latest/module/CMakePackageConfigHelpers.html#command:write_basic_package_version_file">write_basic_package_version_file</a>
command from <code>CMakePackageConfigHelpers</code> module.</p>
</div>
<div class="paragraph">
<p>Here is the resulting code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake"># Generate config file in the build tree
configure_file(${CMAKE_SOURCE_DIR}/cmake/PackageConfig.cmake.in
               ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
               @ONLY)

# Generate the version file in the build tree
if(PROJECT_VERSION)
    include(CMakePackageConfigHelpers)
    set(_version_file ${CMAKE_BINARY_DIR}/${CMAKE_PROJECT_NAME}ConfigVersion.cmake)
    write_basic_package_version_file(${_version_file}
        VERSION ${PROJECT_VERSION}
        COMPATIBILITY AnyNewerVersion)
endif()

# Install the config and version files over to the install tree
install(FILES ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
              ${_version_file}
        DESTINATION lib/cmake/${PROJECT_NAME})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first command requires the following template file to be added in the <code>cmake</code> folder at the root of the repository:</p>
</div>
<div class="listingblock">
<div class="title">cmake/PackageConfig.cmake.in</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">include("${CMAKE_CURRENT_LIST_DIR}/@PROJECT_NAME@Targets.cmake")</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It currently seems this file introduces an extra indirection for no reason, yet this template will grow larger with further steps.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>AnyNewerVersion</code> can be replaced by any valid value for
<a href="https://cmake.org/cmake/help/v3.14/module/CMakePackageConfigHelpers.html#command:write_basic_package_version_file">the <code>COMPATIBILITY</code> argument</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_putting_it_together">Putting it together</h4>
<div class="paragraph">
<p>For a repository containing a <strong>single component</strong>, an updated leaf <code>CMakeLists.txt</code> able to produce a CMake package would look something like:</p>
</div>
<div class="listingblock">
<div class="title">src/libs/A/A/CMakeLists.txt</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">project(A VERSION "${CMAKE_PROJECT_VERSION}")

set(${PROJECT_NAME}_HEADERS
    accumulate.h
    sum.h
)

set(${PROJECT_NAME}_SOURCES
    accumulate.cpp
    sum.cpp
)

find_package(UpstreamOne REQUIRED)
find_package(UpstreamTwo 1.0 REQUIRED COMPONENTS CompA CompB)
find_package(UpstreamThree 3.2.5 EXACT REQUIRED)

# Creates the library target
add_library(${PROJECT_NAME}
            ${${PROJECT_NAME}_HEADERS}
            ${${PROJECT_NAME}_SOURCES})

add_library(myrepo::${PROJECT_NAME} ALIAS ${PROJECT_NAME})

# Defines target requirements
target_include_directories(${PROJECT_NAME}
    PUBLIC
        "$&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../&gt;"
    INTERFACE
        "$&lt;INSTALL_INTERFACE:include/${PROJECT_NAME}&gt;")

target_link_libraries(${PROJECT_NAME}
    PUBLIC
        nsOne::UpstreamOne
        nsTwo::CompA
        nsTwo::CompB
    PRIVATE
        nsThree::UpstreamThree
    INTERFACE
        myrepo::B)

# Defines target properties
set_target_properties(${PROJECT_NAME}
    PROPERTIES
        VERSION "${${PROJECT_NAME}_VERSION}")

<strong>install(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}Targets)
install(FILES ${${PROJECT_NAME}_HEADERS}
        DESTINATION include/${PROJECT_NAME}/${PROJECT_NAME})

# build tree
export(EXPORT ${PROJECT_NAME}Targets
       FILE ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Targets.cmake
       NAMESPACE myrepo::)
configure_file(${CMAKE_SOURCE_DIR}/cmake/PackageConfig.cmake.in
               ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
               @ONLY)
if(PROJECT_VERSION)
    include(CMakePackageConfigHelpers)
    set(_version_file ${CMAKE_BINARY_DIR}/${CMAKE_PROJECT_NAME}ConfigVersion.cmake)
    write_basic_package_version_file(${_version_file}
        VERSION ${PROJECT_VERSION}
        COMPATIBILITY AnyNewerVersion)
endif()

# install tree
install(EXPORT ${PROJECT_NAME}Targets
        FILE ${PROJECT_NAME}Targets.cmake
        DESTINATION lib/cmake/${PROJECT_NAME}
        NAMESPACE myrepo::)
install(FILES ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
              ${_version_file}
        DESTINATION lib/cmake/${PROJECT_NAME})</strong></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point</div>
<div class="paragraph">
<p>This task appears to be generic, yet requires to add many line of codes, repeated in each leaf <code>CMakeLists.txt</code>.
This boilerplate will grow even larger as <a href="#cmake-package-upstream-dependencies">package handle their direct dependencies</a>.<br>
For the moment, it is recommended to factorise this logic in a custom CMake function, yet it should ideally
be discussed with CMake experts and maintainers to see if this situation can be streamlined.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_components_in_a_single_cmake_package">Multiple components in a single CMake package</h4>
<div class="paragraph">
<p>The approach described above will produce a CMake package with the name of the leaf project (<code>A</code>, in this specific case).
This is satisfying for single component repositories, yet a complication arises in the case of multiple components per repo.</p>
</div>
<div class="paragraph">
<p>When applied in a repository containing many components, this produces as many packages as there are components.
This means downstream would issue a distinct <code>find_package()</code> to find each required component, each being a separate CMake package.<br>
Yet, CMake would still install all components from the repository under the common path prefix <code>CMAKE_INSTALL_PREFIX</code>.
Due to the <code>find_package()</code> <a href="https://cmake.org/cmake/help/latest/command/find_package.html#search-procedure">search procedure</a>,
this would imply providing CMake with one distinct hint for each component, in each upstream repository.</p>
</div>
<div class="paragraph">
<p>Instead, {Sonat} relies on the ability of <code>find_package()</code> to locate several components under a common top-level package name:<br>
This fits naturally with the <em>anyrepo</em> model, as each leaf <code>CMakeLists.txt</code> will map to a component, and the top level <code>project()</code> name (the repository) will map to the package name.<br>
It will notably allow to locate <strong>all components</strong> in <strong>all repositories</strong> by providing <a href="#cmake-single-hint"><strong>a single CMake hint</strong></a>.
(leveraging the  <code>&lt;prefix&gt;/&lt;name&gt;*/(lib/&lt;arch&gt;|lib*|share)/cmake/&lt;name&gt;*/</code> search entry).</p>
</div>
<div class="paragraph">
<p>To implement this multiple components approach, an additional CMake config file is issued, named after the top level project.
This step naturally fits the top-level CMake file:</p>
</div>
<div class="listingblock">
<div class="title">CMakeLists.txt</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake"># CMake initialisation
cmake_minimum_required(VERSION 3.15)

# Setting the VERSION on root project() will populate CMAKE_PROJECT_VERSION
project(MyRepository
        VERSION "${BUILD_VERSION}")

# Common build settings
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

# Include components
add_subdirectory(src)

<strong># Multi-component package
# Generate the root config and version check in the build tree
configure_file(${CMAKE_SOURCE_DIR}/cmake/ComponentPackageRootConfig.cmake.in
               ${CMAKE_BINARY_DIR}/${CMAKE_PROJECT_NAME}Config.cmake
               @ONLY)
if(PROJECT_VERSION)
    include(CMakePackageConfigHelpers)
    set(_version_file ${CMAKE_BINARY_DIR}/${CMAKE_PROJECT_NAME}ConfigVersion.cmake)
    write_basic_package_version_file(${_version_file}
        VERSION ${CMAKE_PROJECT_VERSION}
        COMPATIBILITY AnyNewerVersion)
endif()

# Install the root config file over to the install tree
install(FILES ${CMAKE_BINARY_DIR}/${CMAKE_PROJECT_NAME}Config.cmake
              ${_version_file}
        DESTINATION lib/cmake/${CMAKE_PROJECT_NAME})</strong></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
This uses the root <code>project()</code> name as the package name.
Matching this name with the repository&#8217;s name is a convenient solution.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The added code relies on additional template file <code>ComponentPackageRootConfig.cmake.in</code>
to exist in <code>cmake</code> folder:</p>
</div>
<div class="listingblock">
<div class="title">cmake/ComponentPackageRootConfig.cmake.in</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">if (NOT @CMAKE_PROJECT_NAME@_FIND_COMPONENTS)
    set(@CMAKE_PROJECT_NAME@_NOT_FOUND_MESSAGE "The \"@CMAKE_PROJECT_NAME@\" package requires at least one component")
    set(@CMAKE_PROJECT_NAME@_FOUND False)
    return()
endif()

include(CMakeFindDependencyMacro)
foreach(module ${@CMAKE_PROJECT_NAME@_FIND_COMPONENTS})
    set (_config_location "${CMAKE_CURRENT_LIST_DIR}")
    # find_dependency should forward the QUIET and REQUIRED arguments
    find_dependency(${module} CONFIG
                    PATHS "${_config_location}"
                    NO_DEFAULT_PATH)
    unset(_config_location)
    if (NOT ${module}_FOUND)
        if (@CMAKE_PROJECT_NAME@_FIND_REQUIRED_${module})
            string(CONCAT _@CMAKE_PROJECT_NAME@_NOTFOUND_MESSAGE
                   "Failed to find @CMAKE_PROJECT_NAME@ component \"${module}\" "
                   "config file at \"${_config_location}\"\n")
        elseif(NOT @CMAKE_PROJECT_NAME@_FIND_QUIETLY)
            message(WARNING "Failed to find @CMAKE_PROJECT_NAME@ component \"${module}\" "
                             "config file at \"${_config_location}\"")
        endif()
    endif()
endforeach()

if (_@CMAKE_PROJECT_NAME@_NOTFOUND_MESSAGE)
    set(@CMAKE_PROJECT_NAME@_NOT_FOUND_MESSAGE "${_@CMAKE_PROJECT_NAME@_NOTFOUND_MESSAGE}")
    set(@CMAKE_PROJECT_NAME@_FOUND False)
endif()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Execution of this Config script might be recursive via the find_dependency call,
in cases where components in the same project depend on each other.
Since all invocations occur in the same "variable scope", the <code>unset(_config_location)</code> would also
erase the value in the "calling context", even if unset would occur after the loop completes.
For this reason, re-set <code>_config_location</code> variable at each iteration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This template leverages the config files still produced and installed by each individual component in order to locate them,
via the call to <a href="https://cmake.org/cmake/help/latest/module/CMakeFindDependencyMacro.html"><code>find_dependency()</code></a>.</p>
</div>
<div class="paragraph">
<p>This multi-component transformation also induces two changes in the leaf CMakeLists.txt compared to what was presented above:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The version file is already generated at the top level, no need to version components individually</p>
</li>
<li>
<p>The install destination must be adapted to match the root project name.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">src/libs/A/A/CMakeLists.txt</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">project(A VERSION "${CMAKE_PROJECT_VERSION}")

set(${PROJECT_NAME}_HEADERS
    accumulate.h
    sum.h
)

set(${PROJECT_NAME}_SOURCES
    accumulate.cpp
    sum.cpp
)

find_package(UpstreamOne REQUIRED)
find_package(UpstreamTwo 1.0 REQUIRED COMPONENTS CompA CompB)
find_package(UpstreamThree 3.2.5 EXACT REQUIRED)

# Creates the library target
add_library(${PROJECT_NAME}
            ${${PROJECT_NAME}_HEADERS}
            ${${PROJECT_NAME}_SOURCES})

add_library(myrepo::${PROJECT_NAME} ALIAS ${PROJECT_NAME})

# Defines target requirements
target_include_directories(${PROJECT_NAME}
    PUBLIC
        "$&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../&gt;"
    INTERFACE
        "$&lt;INSTALL_INTERFACE:include/${PROJECT_NAME}&gt;")

target_link_libraries(${PROJECT_NAME}
    PUBLIC
        nsOne::UpstreamOne
        nsTwo::CompA
        nsTwo::CompB
    PRIVATE
        nsThree::UpstreamThree
    INTERFACE
        myrepo::B)

# Defines target properties
set_target_properties(${PROJECT_NAME}
    PROPERTIES
        VERSION "${${PROJECT_NAME}_VERSION}")

install(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}Targets)
install(FILES ${${PROJECT_NAME}_HEADERS}
        DESTINATION include/${PROJECT_NAME}/${PROJECT_NAME})

# build tree
export(EXPORT ${PROJECT_NAME}Targets
       FILE ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Targets.cmake
       NAMESPACE myrepo::)
configure_file(${CMAKE_SOURCE_DIR}/cmake/PackageConfig.cmake.in
               ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
               @ONLY)

<strong># Removed lines</strong>

# install tree
install(EXPORT ${PROJECT_NAME}Targets
        FILE ${PROJECT_NAME}Targets.cmake
        DESTINATION lib/cmake/<strong>${CMAKE_PROJECT_NAME}</strong>
        NAMESPACE myrepo::)
install(FILES ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
              <strong># Removed line</strong>
        DESTINATION lib/cmake/<strong>${CMAKE_PROJECT_NAME}</strong>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cmake-package-upstream-dependencies">Finding upstream dependencies from a CMake package</h4>
<div class="paragraph">
<p>The current CMake code allows downstreams to find requested components in a package, each component
 in turn forwarding its direct requirements, those direct requirements in turn doing the same:
 the requirements are transitively forwarded by a recursive traversal of the upstream dependencies graph.</p>
</div>
<div class="paragraph">
<p>Yet, for this exhaustive process to take place, each upstream must be found
(so its corresponding <code>IMPORTED</code> target does exist in the current CMake context)
before it is expressed as a direct dependency on a target
(via <code>target_link_libraries</code> for dependencies found as <code>IMPORTED</code> targets).</p>
</div>
<div class="paragraph">
<p>When implementing a component following {Sonat}, its direct dependencies are all found in the component&#8217;s leaf <code>CMakeLists.txt</code>: this takes care of the first level of dependency.
Yet, those direct dependencies might have their own dependencies, which are no directly found in the current <code>CMakeLists.txt</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
The <code>xxxTarget.cmake</code> file generated by CMake for the direct dependencies does not find its direct dependencies.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To be properly <strong>self-contained</strong>, a CMake package must thus <strong>find its direct dependencies</strong>.
Issuing the necessary <code>find_</code> commands <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#creating-a-package-configuration-file">is a responsibility left to the package developer</a>.
The official CMake documentation recommends to find the dependencies for the packaged component directly in its <code>xxxConfig.cmake</code> file.
Yet, explicitly writing the <code>find_</code> calls in both the leaf <code>CMakeLists.txt</code> and its generated <code>xxxConfig.cmake</code> would be <strong>a major violation of DRY</strong>.</p>
</div>
<div class="paragraph">
<p>{Sonat} improvises a solution to keep a single occurrence of the dependencies list, using only CMake facilities.
The calls to <code>find_package</code> are moved away from the leaf <code>CMakeLists.txt</code> to a custom template file <code>CMakeFinds.cmake.in</code>, where the following tokens are wrapped in <code>@</code> pairs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>find_package</code></p>
</li>
<li>
<p><code>REQUIRED</code></p>
</li>
<li>
<p><code>QUIET</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">src/libs/A/A/CMakeFinds.cmake.in</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">@find_package@(UpstreamOne @REQUIRED@)
@find_package@(UpstreamTwo 1.0 @REQUIRED@ COMPONENTS CompA CompB)
@find_package@(UpstreamThree 3.2.5 EXACT @REQUIRED@ @QUIET@)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Resulting <code>CMakeFinds.cmake</code> is not a standard CMake file.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
CMake documentation also implies that <em>only</em> <code>PUBLIC</code> dependencies must be found for downstreams. Yet, <a href="#cmake-private-might-forward">as seen earlier</a>, this might also be the case for some <code>PRIVATE</code> dependencies, for example static libraries.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In <code>CMakeLists.txt</code>, the different <code>find_package()</code> calls are replaced with a single configuration of the above and execution of the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">function(local_find)
    set (REQUIRED "REQUIRED")
    set (QUIET "QUIET")
    set (find_package "find_package")
    configure_file(CMakeFinds.cmake.in CMakeFinds.cmake @ONLY)
    include(${CMAKE_CURRENT_BINARY_DIR}/CMakeFinds.cmake)
endfunction()
local_find()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The sole purpose of defining a function here instead of inlining its content is to scope the defined variable to a restricted block.
In production code, this function should likely be factorised outside of any leaf <code>CMakeLists.txt</code>, and reused.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In substance, this generates a file with a content strictly equal to what was removed from the leaf <code>CMakeLists.txt</code>, and includes it: functionally equivalent.
Yet, it will now be possible to reuse this information from the <code>AConfig.cmake</code> file after configuring it with different substitutions.</p>
</div>
<div class="paragraph">
<p>Yet, this does not address the case of internal dependencies: in the current example <code>A</code> having a requirement for <code>myrepo::B</code> is an internal dependency.<br>
Since those targets are already defined under the same repository / same root <code>CMakeLists.txt</code>, they are not found via calls to <code>find_package</code> in their sibling components (in the build tree).
On the other hand, when exporting a <code>xxxConfig.cmake</code> file, those sibling targets are not defined anymore.
The package developer must then once again take measures to make sure they are explicitly found in the install tree.</p>
</div>
<div class="paragraph">
<p><a id="cmake-internal-dependencies-lists"></a>{Sonat} avoids duplication by defining re-usable list(s) of internal dependencies in the leaf <code>CMakeLists.txt</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake"><strong>set(${PROJECT_NAME}_INTERNAL_INTERFACE_DEPENDENCIES
    B)</strong>

#...

<strong>list(TRANSFORM ${PROJECT_NAME}_INTERNAL_INTERFACE_DEPENDENCIES PREPEND myrepo::)</strong>
target_link_libraries(${PROJECT_NAME}
    PUBLIC
        nsOne::UpstreamOne
        nsTwo::CompA
        nsTwo::CompB
    PRIVATE
        nsThree::UpstreamThree
    INTERFACE
        <strong>${${PROJECT_NAME}_INTERNAL_INTERFACE_DEPENDENCIES}</strong>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This also achieves functional equivalence to the previous solution, with the added ability to reuse this information for the generated <code>AConfig.cmake</code> file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>myrepo::</code> namespace is not directly prepended to the value(s) when the list is <code>set()</code>.<br>
This list will also be used as a list of components in a <code>find_dependency</code> call,
and components names in this context cannot be prefixed with the namespace.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, the dependencies information has to be made available and consumed by the package <code>AConfig.cmake</code> file.</p>
</div>
<div class="sect4">
<h5 id="_making_dependency_information_available">Making dependency information available</h5>
<div class="paragraph">
<p>Following <a href="https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#creating-a-package-configuration-file">recommendations from the official documentation</a>,
the package will find its upstream dependencies via the <code>find_dependency()</code> macro instead of the <code>find_package()</code> function.
This macro notably forwards <code>QUIET</code> and <code>REQUIRED</code> arguments, so they should not be written explicitly.</p>
</div>
<div class="paragraph">
<p>This is achieved by configuring the <code>CMakeFinds.cmake.in</code> template with different substitutions, in particular no substitution for <code>@REQUIRED@</code> nor <code>@QUIET@</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">function(config_find)
    set (find_package "find_dependency")
    # Configure in build tree
    configure_file(CMakeFinds.cmake.in ${CMAKE_BINARY_DIR}/${PROJECT_NAME}FindUpstream.cmake @ONLY)
endfunction()
config_find()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The resulting configured file appears at the root of the binary directory, instead of in the current binary directory as was the case with <code>local_find()</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This new file has to be deployed to the install tree:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">    install(FILES ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
            # Optional version file if single component repository
            <strong>${CMAKE_BINARY_DIR}/${PROJECT_NAME}FindUpstream.cmake</strong>
            DESTINATION lib/cmake/${CMAKE_PROJECT_NAME})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The root template <code>PackageConfig.cmake.in</code> has to be edited to include this file:</p>
</div>
<div class="listingblock">
<div class="title">cmake/PackageConfig.cmake.in</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake"><strong>include(CMakeFindDependencyMacro) # Provides find_dependency() macro
include("${CMAKE_CURRENT_LIST_DIR}/@PROJECT_NAME@FindUpstream.cmake" OPTIONAL)
@FIND_INTERNAL_COMPONENTS@</strong>

include("${CMAKE_CURRENT_LIST_DIR}/@PROJECT_NAME@Targets.cmake")</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>FIND_INTERNAL_COMPONENTS</code> must be defined to an instruction finding the components in the <a href="#cmake-internal-dependencies-lists">list(s) of internal dependencies</a>.
This takes place in the leaf <code>CMakeLists.txt</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">function(config_find)
    set (find_package "find_dependency")
    configure_file(CMakeFinds.cmake.in ${CMAKE_BINARY_DIR}/${PROJECT_NAME}FindUpstream.cmake @ONLY)

    <strong>list(JOIN ${PROJECT_NAME}_INTERNAL_INTERFACE_DEPENDENCIES " " _joined_components)
    set(FIND_INTERNAL_COMPONENTS
        "find_dependency(${CMAKE_PROJECT_NAME} CONFIG COMPONENTS ${_joined_components})")
    configure_file(${CMAKE_SOURCE_DIR}/cmake/PackageConfig.cmake.in
                   ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
                   @ONLY)</strong>
endfunction()
config_find()</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>configure_file(&#8230;&#8203;PackageConfig.cmake.in &#8230;&#8203;)</code> was moved inside this function, to see the variable.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_putting_it_together_2">Putting it together</h4>
<div class="paragraph">
<p>The install and packaging logic proposed by {Sonat} is now complete, which gives the following final leaf <code>CMakeLists.txt</code> for a multi-components repository:</p>
</div>
<div class="listingblock">
<div class="title">src/libs/A/A/CMakeLists.txt</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake">project(A VERSION "${CMAKE_PROJECT_VERSION}")

set(${PROJECT_NAME}_HEADERS
    accumulate.h
    sum.h
)

set(${PROJECT_NAME}_SOURCES
    accumulate.cpp
    sum.cpp
)

<strong>function(local_find)
    set (REQUIRED "REQUIRED")
    set (QUIET "QUIET")
    set (find_package "find_package")
    configure_file(CMakeFinds.cmake.in CMakeFinds.cmake @ONLY)
    include(${CMAKE_CURRENT_BINARY_DIR}/CMakeFinds.cmake)
endfunction()
local_find()</strong>

<strong>set(${PROJECT_NAME}_INTERNAL_INTERFACE_DEPENDENCIES
    B)</strong>

<strong>function(config_find)
    set (find_package "find_dependency")
    configure_file(CMakeFinds.cmake.in ${CMAKE_BINARY_DIR}/${PROJECT_NAME}FindUpstream.cmake @ONLY)

    list(JOIN ${PROJECT_NAME}_INTERNAL_INTERFACE_DEPENDENCIES " " _joined_components)
    set(FIND_INTERNAL_COMPONENTS
        "find_dependency(${CMAKE_PROJECT_NAME} CONFIG COMPONENTS ${_joined_components})")
    configure_file(${CMAKE_SOURCE_DIR}/cmake/PackageConfig.cmake.in
                   ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
                   @ONLY)
endfunction()
config_find()</strong>

# Creates the library target
add_library(${PROJECT_NAME}
            ${${PROJECT_NAME}_HEADERS}
            ${${PROJECT_NAME}_SOURCES})

add_library(myrepo::${PROJECT_NAME} ALIAS ${PROJECT_NAME})

# Defines target requirements
target_include_directories(${PROJECT_NAME}
    PUBLIC
        "$&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/../&gt;"
    INTERFACE
        "$&lt;INSTALL_INTERFACE:include/${PROJECT_NAME}&gt;")

<strong>list(TRANSFORM ${PROJECT_NAME}_INTERNAL_INTERFACE_DEPENDENCIES PREPEND myrepo::)</strong>
target_link_libraries(${PROJECT_NAME}
    PUBLIC
        nsOne::UpstreamOne
        nsTwo::CompA
        nsTwo::CompB
    PRIVATE
        nsThree::UpstreamThree
    INTERFACE
        <strong>${${PROJECT_NAME}_INTERNAL_INTERFACE_DEPENDENCIES}</strong>)

# Defines target properties
set_target_properties(${PROJECT_NAME}
    PROPERTIES
        VERSION "${${PROJECT_NAME}_VERSION}")

install(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}Targets)
install(FILES ${${PROJECT_NAME}_HEADERS}
        DESTINATION include/${PROJECT_NAME}/${PROJECT_NAME})

# build tree
export(EXPORT ${PROJECT_NAME}Targets
       FILE ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Targets.cmake
       NAMESPACE myrepo::)
<strong>#configure_file(... PackageConfig.cmake.in ...) moved in config_find() above</strong>

# install tree
install(EXPORT ${PROJECT_NAME}Targets
        FILE ${PROJECT_NAME}Targets.cmake
        DESTINATION lib/cmake/${CMAKE_PROJECT_NAME}
        NAMESPACE myrepo::)
install(FILES ${CMAKE_BINARY_DIR}/${PROJECT_NAME}Config.cmake
        <strong>${CMAKE_BINARY_DIR}/${PROJECT_NAME}FindUpstream.cmake</strong>
        DESTINATION lib/cmake/${CMAKE_PROJECT_NAME})</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point: Lengthy boilerplate and hackish workarounds</div>
<div class="paragraph">
<p>As already evoked, the leaf <code>CMakeLists.txt</code> now contains even more generic boilerplate, which should at least <strong>be factorised away in a function</strong>.</p>
</div>
<div class="paragraph">
<p>Is there a canonical way to reduce this?
Would there be interest in turning the repetitive code into an official CMake macro?
Even the explicit code is able to adapt to many more different situations, it feels like this case might be a sane default starting point for modern C++ libraries.</p>
</div>
<div class="paragraph">
<p>Additionally, the current solution to keep the list of external and internal dependencies DRY is a hack, which might be wasteful
(all the dependencies will be "found" by the package consumers, even the <code>PRIVATE</code> dependencies that are actually not forwarded):</p>
</div>
<div class="paragraph">
<p>What is the rationale for not making the automatic <code>xxxTarget.cmake</code> code generation handle the <code>find_</code> directly?
Could CMake provide the actual list of internal and external dependencies <strong>which actually need to be found by consumers</strong> for the packaged target?</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point: find_dependency may have contradictory documentation, and might not behave as expected</div>
<div class="paragraph">
<p>See: <a href="https://stackoverflow.com/q/58221190/1027706" class="bare">https://stackoverflow.com/q/58221190/1027706</a></p>
</div>
<div class="paragraph">
<p>In short, <code>find_dependency(B)</code> indeed forwards <code>REQUIRED</code> from the calling <code>find_package(A)</code>, which makes the call fails in B, without the promised diagnostic mentioning that "A cannot be used without B".</p>
</div>
<div class="paragraph">
<p>A more "natural" approach might actually be not to forward it, since <code>REQUIRED</code> actually only applies to the calling <code>find_package</code>, which might have independently <code>REQUIRED</code> and optional dependencies.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point: Usage of custom CMake variables</div>
<div class="paragraph">
<p>{Sonat} current leaf <code>CMakeLists.txt</code> rely on defining several custom variables.<br>
Yet, different talks regarding modern CMake discourage the use of custom variables
(see <a href="https://youtu.be/bsXLMQ6WgIk?t=830">Daniel Pfeifer example</a>).
Nevertheless, in the absence of a specialised handling of headers and internal target dependencies, as well as a more integrated handling of package upstream dependencies,
this use of variables seems like the lesser evil when compared to DRY violations.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_distribution_conan">Distribution: Conan</h3>
<div class="paragraph">
<p>Once the software exists as a self contained package, making it easily available for its entire intended audience is the next goal.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Here, audience is to be taken broadly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Collaborators (Developers, Testers, etc.)</p>
</li>
<li>
<p>Clients</p>
</li>
<li>
<p>Automated processes (CI, CD, etc.)</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Distributing the package itself is one step, yet the bigger picture is also concerned with its upstream dependencies.</p>
</div>
<div class="sect3">
<h4 id="_motivations_2">Motivations</h4>
<div class="paragraph">
<p>For code to actually become sociable, it must scale all the way from only using a handful of dependencies, to being one component in the middle of a many-thousands dependencies graph.</p>
</div>
<div class="paragraph">
<p>In some organisations, collaborators locally deploy each dependency manually (via compilation or package manager invocations).
This approach is manageable only for shallow dependency graphs, or when most direct dependencies are already well behaved sociable components.</p>
</div>
<div class="paragraph">
<p>There are CMake facilities intended to ease such steps, with the ability to automatically retrieve / build dependencies.
Yet, those automation facilities are usually limited, in the sense that they give only local visibility of the direct dependencies, not the whole-picture dependency graph.</p>
</div>
<div class="paragraph">
<p>Facing the new challenge of distributing components in varying dependency graphs, <a href="https://en.wikipedia.org/wiki/Separation_of_concerns"><strong>separation of concerns</strong></a> is an important consideration:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">{Sonat} relies on CMake to do one thing well</dt>
<dd>
<p>describe the local build process for the repository&#8217;s component(s) in a portable, tool and platform agnostic textual format.<br></p>
</dd>
<dt class="hdlist1">Dependencies management is a separate goal</dt>
<dd>
<p>retrieving all the artifacts for the dependencies, while handling recursion through the upstream graph (addressing different complications, such as reconciliation of diamond sub-graphs)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When it comes to handling dependencies, a scalable and well-accepted solution is to use a package manager.<br>
In the context of {Sonat}, a package manager should offer those essential features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cross-platform and cross-toolset</p>
</li>
<li>
<p>Versionable with the code</p>
</li>
<li>
<p>Testable</p>
</li>
<li>
<p>Handle dependencies versioning</p>
</li>
<li>
<p>Ability to generate a complete (recursive) dependency graph, and handle reconciliation of duplicated dependencies in different versions</p>
</li>
<li>
<p>Usable by developers, automated processes, and end-users.</p>
</li>
<li>
<p>Good defaults, with advanced customisation</p>
</li>
<li>
<p>Artifacts caching and sharing (for time-consuming builds and space-consuming resulting binaries)</p>
</li>
<li>
<p>First-class support for the specificity of C&#43;&#43; (native) code, see <a href="#special_case">C&#43;&#43; special case</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>{Sonat} relies on <a href="https://conan.io/">Conan</a>, self-dubbed <em>the C / C++ Package Manager for Developers</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Conan is cross-toolset in two ways: it offers <a href="https://docs.conan.io/en/latest/integrations.html">integrated support for many major tools</a>,
while also allowing to easily issue system commands to handle specific situations and non-modern code repositories.<br>
It notably offers excellent <a href="https://docs.conan.io/en/latest/integrations/build_system/cmake.html">first-class support for CMake with different generators</a>,
making it a good choice to distribute CMake based repositories.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Conan <a href="https://docs.conan.io/en/latest/getting_started.html">Getting Started</a> offers a good first-time walkthrough.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<a href="https://youtu.be/bsXLMQ6WgIk?t=2967">Daniel Pfeifer&#8217;s requirements for a package manager</a> can be satisfied via Conan.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_adding_conan_recipe">Adding Conan recipe</h4>
<div class="paragraph">
<p>Conan relies on <strong>recipes</strong>, either simple declarative <code>conanfile.txt</code>, or both declarative and imperative (greatly customisable) <code>conanfile.py</code>.
Conan follow recipes to produce <strong>packages</strong> (i.e. the resulting artifact) that can be cached, distributed, and directly retrieved by consumers to satisfy dependencies (alleviating the need to build locally).</p>
</div>
<div class="paragraph">
<p>Recipes are fully contained, notably providing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Recipe meta-information</p>
</li>
<li>
<p>Package "variability", via options and settings</p>
</li>
<li>
<p>Separate <a href="https://docs.conan.io/en/latest/reference/conanfile/attributes.html#requires">Code dependencies</a> and <a href="https://docs.conan.io/en/latest/reference/conanfile/attributes.html#build-requires">Build dependencies</a></p>
</li>
<li>
<p>Build procedure</p>
</li>
<li>
<p>Packaging procedure</p>
</li>
<li>
<p>Resulting <a href="https://docs.conan.io/en/latest/reference/conanfile/methods.html#package-info">package-consumer instructions</a>, allowing to use the package</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>{Sonat} implements a single recipe by repository, independently of its number of components.
It can be placed at the root of the repository, yet storing it in a separate <code>conan</code> folder allows to group all Conan related functionalities in one place (e.g. <a href="#conan-testing">testing</a>). This <code>conan</code> folder is a concrete example of the generic tool folders discussed in <a href="#filesystem_organisation">filesystem organization</a>.</p>
</div>
<div id="conanfile_generators" class="listingblock">
<div class="title">conan/conanfile.py</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from conans import ConanFile, CMake, tools


class MyRepositoryConan(ConanFile):
    # Recipe meta-information
    name = "myrepository"
    license = "MIT"
    url = "..."
    description = "A Conan recipe for {Sonat} sample repository"
    topics = ("demonstration")

    # Package variability:
    # Changing those values will result in distinct packages for the same recipe
    settings = "os", "compiler", "build_type", "arch"
    options = {
        "shared": [True, False],
        "build_tests": [True, False],
    }
    default_options = {
        "shared": False,
        "build_tests": False,
    }

    # Code dependencies
    requires = ("upstreamone/1.0@one/stable",
               "upstreamtwo/[&gt;1.0]@two/stable",
               "upstreamthree/[~=3.2.5]@three/stable")

    # Build dependencies
    #   CMake will not need to be installed to build the project
    #   And if it was installed in a non-compatible version, this will take precedence anyway
    build_requires = "cmake_installer/3.15.4@conan/stable"

    # Which generators are run when obtaining the code dependencies, before build()
    generators = "cmake_paths", "cmake"

    # (overridable) defaults for consumers
    build_policy = "missing"


    # Build procedure: code retrieval
    #   Git's repository origin remote and its current revision are captured by recipe export
    scm = {
        "type": "git",
        "subfolder": "cloned_repo",
        "url": "auto",
        "revision": "auto",
        "submodule": "recursive",
    }


    # shared CMake configuration
    def _configure_cmake(self):
        cmake = CMake(self)
        cmake.definitions["BUILD_tests"] = self.options.build_tests
        cmake.configure(source_folder="cloned_repo")
        return cmake


    # Build procedure: actual build
    def build(self):
        cmake = self._configure_cmake()
        cmake.build()


    # Packaging procedure
    def package(self):
        cmake = self._configure_cmake()
        cmake.install()


    # Package-consumer instructions
    def package_info(self):
        self.cpp_info.libs = tools.collect_libs(self)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This recipe has several sections, each of low complexity.
In particular, the build and packaging procedures are short, thanks to <a href="https://docs.conan.io/en/latest/reference/build_helpers/cmake.html">first class integration of CMake in Conan</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In each case, a <code>CMake</code> Python object is instantiated, its attributes defined from the provided settings and options, then it is configured.</p>
</li>
<li>
<p><code>build()</code> or <code>install()</code> method is invoked according to the current step. Packaging leverages the installation logic provided by CMake through the <code>install</code> target.</p>
</li>
</ol>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
{Sonat} introduces a <code>cloned_repo</code> subfolder to clone into.
Invoking <code>conan install</code>, Conan will copy the content of its source folder directly at the root of the build folder.
If we did not clone in a subfolder, the different files at the root of the repository would appear directly at the root of the build folder, which could augment the risk of filename collision.
In other words, it ensures an <em>out of source build</em>, with the specificity that the source folder is nested under the build folder.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>shared</code> option and <code>build_type</code> setting are common in recipes, thus Conan implicitly forwards the corresponding definitions to the CMake object.
On the other hand, the custom <code>build_tests</code> option is manually forwarded. This explicit approach allows complete customisation of the CMake variables.
The documentation provides <a href="https://docs.conan.io/en/latest/reference/build_helpers/cmake.html#definitions">the list of automatic variables</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_taking_a_step_back">Taking a step back</h4>
<div class="paragraph">
<p>As Conan package manager was introduced, now is a good time to take a look at the overall picture.</p>
</div>
<div class="paragraph">
<p>The repository contains a project composed of one or several components. The project needs to be built in order to produce usable artifacts.</p>
</div>
<div class="paragraph">
<p>While CMake manages the details of the build system for an isolated repository, two essentials issues remain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The code is unique, but there is a lot of variability in the produced artifacts.
A first source of variability is the target environment: C&#43;&#43; model is write once, build everywhere (i.e. many times).
There is also variability in how a project is built even for a single defined environment (Debug/Release, compiler flags, C++ standard version, optional components, etc.)</p>
</li>
<li>
<p>Building might require to satisfy an arbitrarily complicated dependency graph.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Conan tool is addressing these two issues: it resolves the dependency graphs,
and it models the variability of environments and projects via <a href="https://github.com/conan-io/conan/issues/794#issuecomment-268515093">options and settings</a>.</p>
</div>
<div class="paragraph">
<p>Between the build system and the Conan tool sits the <strong>recipe</strong>: It lists the different dependencies, as well as the options and settings.
One of its crucial responsibility is to abstract the build system behind the recipe&#8217;s <code>build()</code> method, while making sure each option and setting is properly translated/forwarded.</p>
</div>
</div>
<div class="sect3">
<h4 id="_from_conan_options_and_settings_to_cmake_variables">From Conan options and settings to CMake variables</h4>
<div class="sect4">
<h5 id="_conans_cmake_build_helper">Conan&#8217;s CMake build helper</h5>
<div class="paragraph">
<p>One of {Sonat} goal is to minimise coupling. Conan lives in a higher layer than CMake: it ensues <code>CMakeLists.txt</code> scripts should ideally <strong>not</strong> be aware of Conan, or at the very least should <strong>not</strong> require it.
{Sonat} intends to accommodate a variety of workflows, and it is reasonable for some workflows to build the project directly from CMake generated build files, out of Conan.
(Such use-cases optionally could rely on Conan to provide some, or all, of the upstream dependencies. Flexibility is a virtue).</p>
</div>
<div class="paragraph">
<p>The above recipe uses CMake build helper, which <a href="https://docs.conan.io/en/latest/reference/build_helpers/cmake.html#definitions">implicitly translates some usual Conan options and settings as CMake variables</a>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
If a recipe introduces custom options and settings, it must do all the work to provide the values to the build system and make sure the build system is configured according to those values.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Among the different CMake variables defined by the build helper, some are mapped to native CMake variables (usually variables prefixed with <code>CMAKE_</code>).
CMake directly takes these native variable into account, as such no further steps are required. The build helper notably defines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CMAKE_BUILD_TYPE (from <code>options.build_type</code>)</p>
</li>
<li>
<p>CMAKE_OSX_ARCHITECTURES (from a combination of <code>settings.os</code> and <code>settings.arch</code> or <code>settings.arch_target</code>)</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
This works reliably only if the project&#8217;s CMake scripts do not override the values assigned to those variables.
Is should be considered a bad practice for a CMake script to discard <em>user-provided</em> values for such variables.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Yet, the majority of CMake variables defined by the helper are custom Conan variables (aptly prefixed with <code>CONAN_</code>).<br>
CMake is unaware of such variables, thus those variables would be ignored by default. It results that further explicit steps must be introduced, otherwise the recipe would not fulfil its contract to properly forward the variability to the build system.</p>
</div>
</div>
<div class="sect4">
<h5 id="_conans_cmake_generator">Conan&#8217;s CMake generator</h5>
<div class="paragraph">
<p>As stated above, some extra logic must be introduced to accommodate the <code>CONAN_</code> CMake variables: Conan generated files to the rescue.
One of the early <a href="https://docs.conan.io/en/latest/reference/generators.html">generator</a> proposed by Conan is the <a href="https://docs.conan.io/en/latest/reference/generators/cmake.html">cmake generator</a>.
It generates a <code>conanbuildinfo.cmake</code> file essentially offering three things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define <em>package-namespaced</em> variable, providing values for each upstream package independently</p>
</li>
<li>
<p>Define amalgamation variables, encompassing all the upstream packages</p>
</li>
<li>
<p>Propose a set of user-invokable macros, notably the <code>conan_basic_setup()</code> aggregation of other macros.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some of these macros are handling the <code>CONAN_</code> prefixed variables, to actually apply them to the build system:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>check_compiler_version()</code></p>
</li>
<li>
<p><code>conan_set_std()</code></p>
</li>
<li>
<p><code>conan_set_libcxx()</code></p>
</li>
<li>
<p><code>conan_set_vs_runtime()</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Those varied features allow this generator to easily fit within a vast variety of the pre-existing CMake based projects in circulation: be it an modern Conan-aware CMake infrastructure leveraging <a href="https://docs.conan.io/en/latest/reference/generators/cmake.html#conan-define-targets"><code>conan_define_targets()</code></a> to provide its needed targets, or an old(deprecated)-style CMake project entirely relying on <a href="#old-cmake-vars">setting folder-level property via the loosely-grouped variables</a>.
And there are a great many combinations in between.</p>
</div>
<div class="paragraph">
<p>This might be a reason why it was introduced early in Conan releases, and why it is the advertised generator in the <a href="https://docs.conan.io/en/latest/creating_packages/getting_started.html">Getting started</a> for package creation.
When coupled with <code>conan_basic_setup()</code> invocation, it works reliably in the diverse landscape of CMake based projects, over which Conan developers have little control.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point: Inconsistency in the CMake build helper implicit variables</div>
<div class="paragraph">
<p>As illustrated, the CMake build helper directly sets some variables as native CMake variables, while other variables require CMake scripts logic in order to be taken into account.
This difference likely exists because the helper directly sets all the native variables it can, yet some values can only be translated during the CMake configuration process:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Enforcing the compiler and its version</dt>
<dd>
<p>Currently implemented as a check comparing the Conan provided value to which compiler CMake actually picked.
Is about to change: to be addressed <a href="https://github.com/conan-io/conan/issues/5737">pro-actively via a <code>CMAKE_TOOLCHAIN_FILE</code></a>.</p>
</dd>
<dt class="hdlist1">cppstd and gnuextensions</dt>
<dd>
<p>requires knowing the CMake version, to address versions of CMake before the introduction of native variables <code>CMAKE_CXX_STANDARD</code> and <code>CMAKE_CXX_EXTENSIONS</code>
(in {Sonat} specific case, this version is actually known in advance, since CMake is a <code>build_dependency</code>)</p>
</dd>
<dt class="hdlist1">stdlib</dt>
<dd>
<p>potentially requires extending the <code>CMAKE_CXX_FLAGS</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This inconsistent situation might lead to confusion, and problematic recipes.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_conan_basic_setup_alternative">conan_basic_setup alternative</h5>
<div class="paragraph">
<p>While the cmake generator <em>just works</em> in a variety of different situations, {Sonat} projects have well known and precise characteristics.
They are written against modern target-based CMake, <a href="https://youtu.be/bsXLMQ6WgIk?t=820">keeping away from requirements provided as independent variables</a>.</p>
</div>
<div class="paragraph">
<p><a id="cmake_generator_drawbacks"></a>In {Sonat} specific situation, it might appear that the widely encompassing approach taken by the cmake generator brings a few drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Variable pollution, with a vast majority of globally defined variable remaining unused by the build management</p>
</li>
<li>
<p>Opinionated new defaults, introducing incompatibilities between default Conan builds and default CMake builds.
(e.g. <code>conan_basic_setup()</code> disable RPATH by default, which is not CMake&#8217;s default)</p>
</li>
<li>
<p>Usage of the generated CMake script is invasive, requiring dedicated code in the root <code>CMakeLists.txt</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>{Sonat} aims to write canonical CMake scripts. In his presentation "Effective CMake",
<a href="https://youtu.be/bsXLMQ6WgIk?t=3038">Daniel Pfeifer presents the canonical way to use an external library</a>.
When using an external {Sonat} component, <strong>this syntax is the natural solution</strong>, and it only requires the (concise) output of <a href="https://docs.conan.io/en/latest/integrations/build_system/cmake/cmake_paths_generator.html"><code>cmake_paths</code> generator</a>.</p>
</div>
<div class="paragraph">
<p><code>cmake_paths</code> generated script only populates 2 variables, and it does not define any logic. It can be included non-intrusively either as a toolchain, or indirectly at CMake <code>project()</code> invocation.<br>
{Sonat} advocates the second solution. The generated <code>conan_paths.cmake</code> script is included by <code>MyRepository</code> project when CMake (or Conan&#8217;s CMake build helper) is configured, by defining the following variable beforehand:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>CMAKE_PROJECT_MyRepository_INCLUDE=.../conan_paths.cmake</pre>
</div>
</div>
<div class="paragraph">
<p>This inclusion allows the canonical invocations of <code>find_package()</code> to correctly find any Conan-retrieved packages.</p>
</div>
<div class="paragraph">
<p>Yet, further steps are still needed to actually translate the <code>CONAN_</code> prefixed variables into variables understood by CMake.
As discussed above, the plain <code>cmake</code> generator is outputting a file already providing the necessary logic (among other things).</p>
</div>
<div class="paragraph">
<p>{Sonat} follows a pragmatic approach, <a href="#conanfile_generators">invoking both Conan generators</a> as seen in the recipe,
and introducing an additional CMake script to glue them together:</p>
</div>
<div class="listingblock">
<div class="title">conan/customconan.cmake</div>
<div class="content">
<pre class="highlight"><code class="language-cmake" data-lang="cmake"># Cannot be a function: some invoked macro modify global variables
macro(conan_handle_compiler_settings)
    include(${CMAKE_BINARY_DIR}/conanbuildinfo.cmake)

    if(CONAN_EXPORTED)
        conan_message(STATUS "Conan: called by CMake conan helper")
    endif()

    if(CONAN_IN_LOCAL_CACHE)
        conan_message(STATUS "Conan: called inside local cache")
    endif()

    check_compiler_version()
    conan_set_std()
    conan_set_libcxx()
    conan_set_vs_runtime()
endmacro()

include(${CMAKE_BINARY_DIR}/conan_paths.cmake)
conan_handle_compiler_settings()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Conan recipe itself must also be edited in order to include this file. It is achieved by pointing the CMake variable <code>CMAKE_PROJECT_&lt;name&gt;_INCLUDE</code> to the file above:</p>
</div>
<div class="listingblock">
<div class="title">conan/conanfile.py</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from conans import ConanFile, CMake, tools

<strong>from os import path</strong>

    ...

    def _configure_cmake(self):
        cmake = CMake(self)
        <strong>cmake.definitions["CMAKE_PROJECT_MyRepository_INCLUDE"] = \
            path.join(self.source_folder, "cloned_repo", "conan", "customconan.cmake")</strong>
        cmake.definitions["BUILD_tests"] = self.options.build_tests
        cmake.configure(source_folder="cloned_repo")
        return cmake

    ...</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point: Waiting for Conan generation of toolchain files</div>
<div class="paragraph">
<p>Working around the <a href="#cmake_generator_drawbacks">presented drawbacks</a> only grew the infrastructure code in each repository even larger.<br>
There is currently an issue tracking Conan <a href="https://github.com/conan-io/conan/issues/5737">Build toolchain POC</a>.
It could be beneficial to consider whether the subset of <code>conan_basic_setup()</code> invoked in this <code>customconan.cmake</code> could fit in such a toolchain file, alleviating the need for this custom file.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point: Upstream dependencies duplication</div>
<div class="paragraph">
<p>The current approach uses distinct <code>CMake</code> and <code>Conan</code> tools.
This separation offers many benefits, yet there is an important overlap when it comes to upstream dependencies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CMake</code> scripts (the leaves <code>CMakeLists.txt</code>) find and explicitly register dependencies in the build specification for each component.</p>
</li>
<li>
<p><code>Conan</code> retrieves and reconciliates dependencies in a complete dependency graph, based on an explicit list of all dependencies for the repository.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a form of repetition here, bringing the potential problem usually associated with duplication.
For example, if the only component using a given upstream dependencies gets rid of this dependency, the repository as a whole does not depend on this upstream anymore.
Yet, there is a risk to forget to remove this same dependency from the Conan recipe.</p>
</div>
</div>
</div>
<div id="conan-friction-consuming-generators" class="sidebarblock">
<div class="content">
<div class="title">Friction point: Consuming {Sonat} packages from other Conan generators.</div>
<div class="paragraph">
<p>{Sonat} relies on the convenient CMake system of exported targets to ensure propagation of <a href="#cmake-requirements-scopes">usage requirements</a>.
This works consistently without any extra effort, <strong>as longs as all downstream(s) are consuming CMake targets</strong>. This is the recommended approach (otherwise, read below)</p>
</div>
<div class="paragraph">
<p>Conan also offers a mechanism to specify a package usage requirements, via <a href="https://docs.conan.io/en/latest/reference/conanfile/attributes.html#cpp-info"><code>cpp_info</code> to be populated in <code>package_info()</code></a>.
When this attribute is correctly configured, the package can be consumed via other Conan generators.
For the repository in this guide, it would at least require to list individual include paths for the library components (<code>include/A</code> and <code>include/B</code>),
since {Sonat} duplicates the component folder exactly for this reason (not being able to access separate components from a common include path). There might also be compiler flags, etc.</p>
</div>
<div class="paragraph">
<p>Unfortunately, this would raise two problems:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Duplication of information</dt>
<dd>
<p>{Sonat} already defines all <strong>usage requirements</strong> at CMake level, having to maintain a second <em>source of truth</em> might lead to discrepancies and maintenance complications.</p>
</dd>
<dt class="hdlist1">Granularity mismatch for multi-component projects</dt>
<dd>
<p>CMake is defining <strong>usage requirements</strong> per-target, which usually means per-component in {Sonat}.
Yet, the <code>cpp_info</code> configuration is unaware of such component granularity, and {Sonat} single recipe approach defines the Conan requirements globally, at the repository level.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="conan-testing">Testing the recipe</h4>
<div class="paragraph">
<p>A Conan recipe is yet another piece of code versioned in your repository, and it should be treated as such.
It should notably be tested.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The scope of this test is not to validate the fitness of the business code provided by the repository,
but to validate that a Conan recipe produces conformant and usable packages.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Conan tools provide <a href="https://docs.conan.io/en/latest/creating_packages/getting_started.html#the-test-package-folder">facilities to run such test on recipe</a>,
usually via a <code>test_package</code> folder living next to the actual <code>conanfile.py</code> recipe.
{Sonat} follows this convention, and could even rely on the default <code>test_folder</code> generated by <a href="https://docs.conan.io/en/latest/reference/commands/creator/new.html"><code>conan new -t</code></a>.</p>
</div>
<div class="paragraph">
<p>Such folder usually consists of 3 files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>conan/test_package/example.cpp</code></p>
</li>
<li>
<p><code>conan/test_package/CMakeLists.txt</code></p>
</li>
<li>
<p><code>conan/test_package/conanfile.py</code></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_test_package_c_consumer">test_package C&#43;&#43; consumer</h5>
<div class="listingblock">
<div class="title">conan/test_package/example.cpp</div>
<div class="content">
<pre>#include &lt;A/accumulate.h&gt;
#include &lt;A/sum.h&gt;

int main()
{
    myns::accumulate(3);
    myns::sum(myns::sum(3, 2), 1);
}</pre>
</div>
</div>
<div class="paragraph">
<p>Includes headers from component(s) provided by the repository, and use some symbols they define.
This ensure the include paths are correctly set, and the ability to link the symbols.</p>
</div>
</div>
<div class="sect4">
<h5 id="_test_package_cmake_project">test_package CMake project</h5>
<div class="listingblock">
<div class="title">conan/test_package/CMakeLists.txt</div>
<div class="content">
<pre>cmake_minimum_required(VERSION 2.8.12)
project(PackageTest CXX)

set(CMAKE_RUNTIME_OUTPUT_DIRECTORY $&lt;1:${CMAKE_CURRENT_BINARY_DIR}&gt;)

find_package(MyRepository REQUIRED COMPONENTS A)

add_executable(example example.cpp)
target_link_libraries(example myrepo::A)</pre>
</div>
</div>
<div class="paragraph">
<p>Simple CMake project, defining the <code>example</code> target to compile the above <code>example.cpp</code> file.
It also finds the component(s) used by the code, and mark them as upstream dependencies for the target.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>CMAKE_RUNTIME_OUTPUT_DIRECTORY</code> is re-defined to its default value, but via a dummy generator expression. This way, multi-configurations generators <a href="https://cmake.org/cmake/help/latest/prop_tgt/RUNTIME_OUTPUT_DIRECTORY.html">do not append a per-configuration subdirectory</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_test_package_recipe">test_package recipe</h5>
<div class="listingblock">
<div class="title">conan/test_package/conanfile.py</div>
<div class="content">
<pre>import os

from conans import ConanFile, CMake, tools


class MyRepositoryTestConan(ConanFile):
    settings = "os", "compiler", "build_type", "arch"
    generators = "cmake_paths", "cmake"

    build_requires = "cmake_installer/3.15.4@conan/stable"

    def build(self):
        cmake = CMake(self)
        cmake.definitions["CMAKE_PROJECT_PackageTest_INCLUDE"] = "../customconan.cmake"
        cmake.configure()
        cmake.build()

    def imports(self):
        self.copy("*.dll", dst="bin", src="bin")
        self.copy("*.dylib*", dst="bin", src="lib")
        self.copy('*.so*', dst='bin', src='lib')

    def test(self):
        if not tools.cross_building(self.settings):
            self.run(".%sexample" % os.sep)</pre>
</div>
</div>
<div class="paragraph">
<p>Simple recipe, it builds the test folder via the above <code>CMakesLists.txt</code> file.
No need to explicitly state <code>requires</code> of the tested package, Conan will automatically inject it.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
The testing recipe could use the base <code>cmake</code> generator only, as long as <a href="#conan-friction-consuming-generators">this friction point is handled by the tested recipe</a>.
Sticking to {Sonat}, this testing recipe prefers to use <code>conan/customconan.cmake</code> in a similar manner to the tested recipe.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage">Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_affinity_with_different_workflows">Affinity with different workflows</h3>
<div class="paragraph">
<p>{Sonat} is a process addressing the infrastructure aspects of code projects. Its ability to cater for different workflows is thus an important aspect of it applicability.<br>
Getting more general than <em>cross-tool</em> and <em>cross-platform</em> qualities, it is possible to establish an coarse spectrum of workflows based on usages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Development</p>
</li>
<li>
<p>Command line user</p>
</li>
<li>
<p>General public/end-user (customer, in the marketing sense)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is a coarse outline, hopefully introducing the most usual situations.
The following usage recommendations should easily adapt to situations in-between.</p>
</div>
<div class="sect3">
<h4 id="_prerequisites">Prerequisites</h4>
<div class="paragraph">
<p>A recipe is self-contained via its code and build dependencies.<br>
Thanks to that, using {Sonat} projects might only require:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the target compiler (or IDE)</p>
</li>
<li>
<p><a href="https://docs.conan.io/en/latest/installation.html#install">Conan installation</a> (running on Python 3)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
CMake is a provided by Conan as a build requirement, but an explicit installation of CMake will be required in situations where a {Sonat} project is built out of Conan.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_development">Development</h3>
<div class="paragraph">
<p>During development, the build responsibility is taken out of Conan, to place more control into the hand of the developers.
It additionally requires an appropriate version of CMake to be available on the system.</p>
</div>
<div class="sect3">
<h4 id="development-isolation">Development in isolation</h4>
<div class="paragraph">
<p>This scenario refers to developing the component in isolation:
all upstream dependencies are available as installed Conan packages (by opposition to being accessed from their CMake install or build tree).</p>
</div>
<div class="paragraph">
<p>This scenario is naturally addressed by the system described above, and illustrates well how Conan can complement development environments (making it a one line call to satisfy all dependencies) without staying in the way (once the dependencies are retrieved, Conan might not be needed anymore).</p>
</div>
<div class="listingblock">
<div class="title">The canonical steps for a <code>beneficialproject</code> repository:</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"># Clone the project and move to the folder for out-of-source build
git clone --recurse-submodules ${repository}/beneficialproject.git
mkdir beneficialproject/build
cd beneficialproject/build

# Install all dependencies in the dependency graph
# Will also generate files for generators listed in the recipe
conan install ../conan

# Generate project files
cmake -DCMAKE_PROJECT_beneficialproject_INCLUDE=conan/customconan.cmake \
      -DCMAKE_INSTALL_PREFIX=${local_sdk_folder}/beneficialproject \
      ..</code></pre>
</div>
</div>
<div class="paragraph">
<p>From here on, it is possible to forget about Conan. The developer can concentrate on their usual "edit-build-debug" cycle
(e.g. via their familiar IDE, if IDE project files were generated by CMake).</p>
</div>
<div class="paragraph">
<p>Alternatively, to keep it build-system agnostic, CMake might also be invoked to drive the builds.
This might notably be useful for automation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">cmake --build . [--target ...]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_publishing_the_recipe">Publishing the recipe</h4>
<div class="paragraph">
<p>Publishing the recipe is a simple step greatly increasing a project sociability.
It makes it trivial for downstream to consume the recipe&#8217;s component(s).</p>
</div>
<div class="paragraph">
<p>To publish a with identifier <code>beneficialproject/1.2.0@company/stable</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># From the repository root
conan create ./conan 1.2.0@company/stable
conan upload [-r my_remote] beneficialproject/1.2.0@company/stable</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<a href="https://bintray.com/conan/conan-center">conan-center</a> is a free public repository, picked by default in the absence of <code>-r</code> option.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="development-multirepo">Development in multiple-repositories</h4>
<div class="paragraph">
<p>The isolated scenario can be generalised to illustrate development inside an organisation.</p>
</div>
<div class="paragraph">
<p>Unless this organisation strictly adhere to the <a href="#_repositories">monorepo approach</a>,
there might be situations where the development process would imply working on more than one repository at once
(Each repository is a different {Sonat} project).</p>
</div>
<div class="paragraph">
<p>It extends the <a href="#development-isolation">above section</a>: several independent projects will be cloned and built.
The initial motivation to work on several projects is their dependency relationship.<br>
It implies to provide hints to CMake regarding the location of downstream projects which are manually cloned and built.
This is required so their <code>find_package</code> calls can locate the local upstream(s), which are out of Conan&#8217;s cache.</p>
</div>
<div class="paragraph">
<p>Assuming a development task implying to work in parallel on the sources of both:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>beneficialproject</code> as handled above</p>
</li>
<li>
<p><code>profitableapp</code>, a downstream dependency of <code>beneficialproject</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">The steps for a profitableapp repository</div>
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">git clone --recurse-submodules ${repository}/profitableapp.git
mkdir profitableapp/build
cd profitableapp/build

# Install a restricted set of dependencies
<strong>conan install ../conan/conanfile-dev.txt</strong>

cmake .. -DPROJECT_profitableapp_INCLUDE=conan/customconan.cmake \
         -DCMAKE_INSTALL_PREFIX=${local_sdk_folder}/profitableapp
         <strong>-DCMAKE_PREFIX_PATH=${local_sdk_folder}</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two changes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Conan does not install the full <code>conan/conanfile.py</code>, but a subset file (named <code>conan/conanfile-dev.txt</code> in this example).
This file only needs to specify the <code>cmake</code> and <code>cmake_paths</code> generators,
<a href="https://docs.conan.io/en/latest/reference/conanfile_txt.html#requires">and to list requirements</a> <strong>excluding all requirements that are manually provided</strong> out of Conan (i.e. excluding <code>beneficialproject</code> in this example).</p>
</li>
<li>
<p><a id="cmake-single-hint"></a>CMake variable <code>CMAKE_PREFIX_PATH</code> points to the local installation folder, where the <code>beneficialproject</code> 's <code>install</code> target would deploy <code>beneficialproject</code> CMake package.
Thanks to the adopted folder structure, this <strong>single hint</strong> is enough to find any {Sonat} conformant package installed under this prefix.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This logic can be extended to explicitly build an arbitrary number of dependencies instead of relying on Conan to provide them.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="title">install tree vs. build tree</div>
<div class="paragraph">
<p>By setting <code>CMAKE_PREFIX_PATH</code> to the install folder, the manually built upstream dependencies are found in their <strong>install tree</strong>.
This means that, before any edition applied to them becomes available to downstream(s), they must first invoke their <code>install</code> target (e.g. <code>cmake --build . --target install</code>)</p>
</div>
<div class="paragraph">
<p>In certain situations, it might be preferable to find the manually built upstream dependencies in their build tree.
In this case, the <strong>single</strong> value provided to <code>CMAKE_PREFIX_PATH</code> should be replaced with <strong>distinct definitions</strong> for each upstream.
In the current example, it would be replaced with<br>
<code>-Dbeneficialproject_DIR=${build_dir}</code>.
Unless a dependency found in its build tree is a header-only library, it should still be rebuilt (but not necessarily installed anymore) in order for changes to propagate downstream.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="friction-distinct-dag" class="sidebarblock">
<div class="content">
<div class="title">Friction point: Distinct dependency graphs</div>
<div class="paragraph">
<p>One feature of a package manager is to reconciliate the dependencies version when several paths in the DAG specify the same recipe in but in different versions.
With this approach, several independent DAGs are generated (one per manually built repository), losing this important feature (because it does not apply across independent graphs boundaries).</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point: The quest for repository component-fluidity</div>
<div class="paragraph">
<p>There is a bigger picture here, a potential to ease the developers experience with a more natural continuity between <a href="#development-isolation">isolated</a> and <a href="#development-multirepo">modularised</a> developments.<br></p>
</div>
<div class="paragraph">
<p>It is a stated goal to allow for the <a href="#anyrepo">anyrepo situation</a>.
As such, allowing any level of repo/module granularity - without getting in the way of developers - brings specific challenges.<br>
In particular <strong>{Sonat} should not limit which projects are provided by Conan, and which projects are built locally</strong>.
The section above propose a pragmatic approach to achieve some level of freedom with the current solution, yet it is far from ideal:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It breaks <a href="#friction-distinct-dag">dependency resolution</a></p>
</li>
<li>
<p>A distinct <code>conanfile-xxx.txt</code> file needs to be created for each combination of locally built upstream dependencies</p>
</li>
<li>
<p>Finding upstream dependencies in their build tree require a distinct explicit CMake-hint per upstream repository</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Properly addressing those issues are challenging, and might require additional tool support.
Yet the potential gains for developers might be equally important.</p>
</div>
<hr>
<div class="paragraph">
<p>From a functional stand-point, an ideal solution might look something like:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A list of components to work on (edit) is specified</p>
</li>
<li>
<p>A process is invoked to:</p>
<div class="ulist">
<ul>
<li>
<p>map the components' repositories to their corresponding recipe identifiers in requirements lists</p>
</li>
<li>
<p>solve the DAG for non-local dependencies and retrieve them in Conan local cache</p>
</li>
<li>
<p>ensure local availability of listed repositories (for local edition and build)</p>
</li>
<li>
<p>[optional] setup out-of-source builds for those local projects</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>There might still be limitations regarding which repositories are allowed to be built locally
(maybe preventing any upstream dependency of a non-local dependency to be built locally).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="command-line-usage">Command-line user</h3>
<div class="paragraph">
<p>This workflow cover the case of consuming a {Sonat} project in a situation where a shell interface is convenient.
It covers different use cases, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automated processes, such as Continuous Integration</p>
</li>
<li>
<p>Situations where all software must be built internally (security policy, compilation options, etc.)</p>
</li>
<li>
<p>Consuming the project when there are no prebuilt binaries for the target environment (or not at all)</p>
</li>
<li>
<p>B2B customer for middleware and general libraries</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assuming a project recipe <a href="#_publishing_the_recipe">was made available</a> on an <a href="https://docs.conan.io/en/latest/reference/commands/misc/remote.html">accessible Conan remote</a>,
with the identifier <code>beneficialproject/1.2.0@provider/stable</code>, consuming it is as simple as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>conan install beneficialproject/1.2.0@provider/stable</pre>
</div>
</div>
<div class="paragraph">
<p>This command will either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>retrieve a package for this recipe when one is available with the current combination of settings and options</p>
</li>
<li>
<p>or build it if this combination is not available (thanks to <code>build_policy = "missing"</code> in the project recipe).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Doing it recursively, consuming all the dependencies along the upstream graph</p>
</div>
<div class="sect3">
<h4 id="_generators">Generators</h4>
<div class="paragraph">
<p>The command above ensures that once it successfully completed, a package for <code>beneficialproject</code> is available in the local Conan cache.
The remaining question is how the consumer expects to use the project, which is notably constrained by the nature of the project.</p>
</div>
<div class="sect4">
<h5 id="_library">Library</h5>
<div class="paragraph">
<p>If the user expects to build upon a library provided by <code>beneficialproject</code>,
an appropriate generator from the <a href="https://docs.conan.io/en/latest/reference/generators.html">many supported build environments</a> must be chosen.</p>
</div>
<div class="paragraph">
<p>For example, to generate a <code>.props</code> file to be imported in a Visual Studio project:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>conan install beneficialproject/1.2.0@provider/stable -g visual_studio</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Of course, such use-case would benefit from applying {Sonat} to the downstream project relying on <code>beneficialproject</code>.
Nevertheless, this example illustrates the potential extension of {Sonat} projects toward downstreams in un-controlled environments.
Be aware that it would require to populate the upstream&#8217;s Conan recipe <code>cpp_info</code>, which {Sonat} currently does not.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_tool">Tool</h5>
<div class="paragraph">
<p>If the user is interested in a tool (executable) provided by <code>beneficialproject</code>, then <a href="https://docs.conan.io/en/latest/devtools/running_packages.html">other generators</a>,
such a virtual environments, will address this situation.</p>
</div>
<div class="paragraph">
<p>For example, to obtain and invoke the <code>usefulgenerator</code> tool in <code>beneficialproject</code> on a GNU/Linux flavoured environment:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>conan install beneficialproject/1.2.0@provider/stable -g virtualrunenv
source activate_run.sh
usefulgenerator --version
source deactivate_run.sh</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
No global system change are taking place. To install a tool user or system wide would more closely match the <a href="#_general_public">end-user</a> scenario.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Friction point</div>
<div class="paragraph">
<p>The activation and deactivation steps are system specific here.
It might be beneficial to have an abstraction (in the same vein as the abstraction over build invocation offered by <code>cmake --build &#8230;&#8203;</code>), notably for matrix based CI processes.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_no_published_recipe">No published recipe</h4>
<div class="paragraph">
<p>In a situation where the recipe is not available in a known remote, it is still possible to use Conan to drive the build process from the project sources.
It is a matter of exporting the recipe from the sources to the local Conan cache, then using it to assemble the package.</p>
</div>
<div class="paragraph">
<p>Given access to the repository content, building the project amounts to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># From the repository root
conan create ./conan ${VERSION}@user/stable</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Such situation is not ideal,
notably making it a consumer responsibility to assign recipe identifiers, such as version, user and channel above.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In the command above, the package name is deduced from the recipe <code>name</code>.
If an explicit version is specified in the recipe meta-information, it is also be possible to omit it on the <code>conan create</code> command line.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_general_public">General public</h3>
<div class="paragraph">
<p>{Sonat} is not addressed at end-users directly: the process relies on qualified tools which are not expected to be available on general public environments.
Yet, adopting such a process which facilitates CI/CD makes it easier to cater for customers.
It offers a good infrastructure on top of which packaging logic can be implemented, then mechanically invoked.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO</div>
<div class="paragraph">
<p>Might be illustrated with adding custom CMake targets to produce Windows <code>msi</code> installers, or macOS <code>app</code> bundles.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_annexes">Annexes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_automated_qa">Automated QA</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">TODO</div>

</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-02-24 17:25:46 UTC
</div>
</div>
</body>
</html>